
    <!-- Header de Acciones -->
    <div class="d-flex justify-content-end mb-2">
        <div class="btn-group btn-group-sm">
            {% if user.is_superuser or property.created_by.id == user.id %}
            <a href="{% url 'properties:edit' property.pk %}" class="btn btn-outline-primary" title="Editar">
                <i class="fas fa-edit me-1"></i>Editar
            </a>
            {% endif %}
            <a href="{% url 'properties:timeline' property.pk %}" class="btn btn-outline-secondary" title="Historial">
                <i class="fas fa-history me-1"></i>Historial
            </a>
            <a href="{% url 'properties:list' %}" class="btn btn-outline-secondary" title="Volver">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
        <a href="{% url 'properties:generate_pdf' property.pk %}" class="btn btn-dark ms-2" title="Generar Resumen" target="_blank">
            <i class="fas fa-file-pdf me-1"></i>Generar Resumen
        </a>
        <button
            type="button"
            id="btnSyncWP"
            class="btn btn-success ms-2"
            data-sync-url="/dashboard/api/internal/wp/sync/{{ property.id }}/"
            title="Subir a WordPress"
        >
            <i class="fas fa-cloud-upload-alt me-1"></i>Subir a WP
        </button>
        <button
            type="button"
            id="btnDeleteWP"
            class="btn btn-danger ms-2"
            data-delete-url="/dashboard/api/internal/wp/property/{{ property.id }}/delete/"
            title="Eliminar de WordPress"
            >
            <i class="fas fa-trash-alt me-1"></i>Eliminar de WP
        </button>
    </div>

    <div class="row g-2">
        <!-- COLUMNA IZQUIERDA: Galería y Resumen Clave (Sticky) -->
        <div class="col-lg-3 col-md-4">
            <div class="d-flex flex-column gap-2 h-100">
                
                <div class="bg-white p-2 rounded shadow-sm border">
                    <!-- Título y Precio -->
                    <div class="mb-2 text-center">
                        <h6 class="fw-bold text-dark mb-1 lh-sm text-truncate" title="{{ property.exact_address|default:property.title }}">
                            {{ property.exact_address|default:property.title }}
                        </h6>
                        {% if field_permissions.price.can_view or not field_permissions.price %}
                        <div class="fw-bold text-primary">
                            {{ property.currency.symbol }} {{ property.price|floatformat:0 }}
                        </div>
                        {% endif %}
                        {% if property.codigo_unico_propiedad %}
                        <div class="text-muted d-block" style="font-size: 0.7rem;"><i class="fas fa-hashtag me-1"></i>{{ property.codigo_unico_propiedad }}</div>
                        {% endif %}
                    </div>

                    <!-- Carrusel de Fotos (Galería) -->
                    <div class="position-relative bg-light rounded overflow-hidden mb-2 border mx-auto" style="aspect-ratio: 4/3; max-height: 200px;">
                        {% if property.images.exists %}
                        <div id="propertyCarousel-{{ property.id }}"
                            class="carousel slide w-100 h-100"
                            data-bs-ride="false">

                            <div class="carousel-inner h-100">
                                {% for image in property.images.all %}
                                {% if image.image %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %} h-100">
                                    <img
                                        src="{{ image.image.url }}"
                                        class="d-block w-100 h-100"
                                        style="object-fit: cover; cursor: zoom-in;"
                                        alt="{{ image.caption|default:'Imagen de propiedad' }}"
                                        onclick="openFullscreenModal('{{ image.image.url }}', '{{ image.caption|escapejs }}')"
                                    >
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>

                            {% if property.images.count > 1 %}
                            <button class="carousel-control-prev" type="button"
                                    data-bs-target="#propertyCarousel-{{ property.id }}"
                                    data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>

                            <button class="carousel-control-next" type="button"
                                    data-bs-target="#propertyCarousel-{{ property.id }}"
                                    data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                            {% endif %}

                            <span class="position-absolute bottom-0 end-0 m-1 badge bg-dark bg-opacity-75">
                                <i class="fas fa-images me-1"></i>{{ property.images.count }}
                            </span>
                        </div>
                        {% else %}
                        <div class="d-flex align-items-center justify-content-center w-100 h-100 text-muted">
                            <i class="fas fa-image fa-2x"></i>
                        </div>
                        {% endif %}

                    </div>

                    <!-- Resumen Rápido -->
                    <div class="row g-1 text-center small text-secondary">
                        <div class="col-4">
                            <div class="p-1 border rounded bg-light" title="Dormitorios">
                                <i class="fas fa-bed mb-1 d-block text-primary" style="font-size: 0.8rem;"></i>
                                <span class="fw-bold text-dark">{{ property.bedrooms }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-1 border rounded bg-light" title="Baños">
                                <i class="fas fa-bath mb-1 d-block text-primary" style="font-size: 0.8rem;"></i>
                                <span class="fw-bold text-dark">{{ property.bathrooms }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-1 border rounded bg-light" title="Cocheras">
                                <i class="fas fa-car mb-1 d-block text-primary" style="font-size: 0.8rem;"></i>
                                <span class="fw-bold text-dark">{{ property.garage_spaces }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Box Responsable / Contacto -->
                 <div class="card shadow-sm border-0 flex-grow-1">
                    <div class="card-header bg-white border-bottom-0 fw-bold text-uppercase small text-muted py-1 px-2">
                        <i class="fas fa-address-card me-2"></i>Contacto
                    </div>
                    <div class="card-body py-2 px-2 small">
                        <div class="mb-2">
                            <strong class="text-dark d-block" style="font-size: 0.75rem;">Propietario</strong>
                            {% if is_owner_or_admin %}
                                {% if property.owner %}
                                    <span class="text-muted d-block text-truncate">{{ property.owner.first_name }} {{ property.owner.last_name }}</span>
                                {% else %}
                                    <span class="text-warning">Sin asignar</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted opacity-50 d-block" style="font-size: 0.7rem;">Vista No Autorizada</span>
                            {% endif %}
                        </div>
                        <div>
                            <strong class="text-dark d-block" style="font-size: 0.75rem;">Responsable</strong>
                            <span class="text-muted d-block text-truncate">{{ property.responsible.get_full_name|default:property.created_by.get_full_name|default:property.created_by.username }}</span>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- COLUMNA CENTRAL: Grid Compacto (Dos columnas verticales para evitar huecos por alturas desiguales) -->
        <div class="col-lg-9 col-md-8">
            <div class="row g-2">
                
                <!-- Subcolumna Izquierda: Básica, Publicidad -->
                <div class="col-12 col-md-6">
                    <div class="d-flex flex-column gap-2 h-100">
                        <!-- 1. INFORMACIÓN BÁSICA -->
                        <div class="card shadow-sm border">
                            <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                                <i class="fas fa-home me-2"></i>Información Básica
                            </div>
                            <div class="card-body pt-0 px-2 pb-2">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Tipo</label>
                                        <div class="text-truncate small">{{ property.property_type.name|default:"-" }}</div>
                                    </div>
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Subtipo</label>
                                        <div class="text-truncate small">{{ property.property_subtype.name|default:"-" }}</div>
                                    </div>
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Estado</label>
                                        <span class="badge bg-light text-dark border small py-0">{{ property.status.name|default:"-" }}</span>
                                    </div>
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Condición</label>
                                        <div class="text-truncate small">{{ property.condition.name|default:"-" }}</div>
                                    </div>
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Forma de Pago</label>
                                        <div class="text-truncate small">{{ property.forma_de_pago.name|default:"-" }}</div>
                                    </div>
                                    <div class="col-6">
                                         <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Mantenimiento</label>
                                         <div class="small">{% if property.has_maintenance %}Sí{% else %}No{% endif %}</div>
                                    </div>
                                    {% if property.is_project %}
                                    <div class="col-12">
                                        <div class="alert alert-info py-1 px-2 small mb-0" style="font-size: 0.75rem;">
                                            <i class="fas fa-building me-1"></i> Proyecto: <strong>{{ property.project_name|default:"-" }}</strong>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if property.antiquity_years or property.delivery_date %}
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Antigüedad</label>
                                        <div class="small">{{ property.antiquity_years|default:"-" }} años</div>
                                    </div>
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Entrega</label>
                                        <div class="small">{{ property.delivery_date|date:"d/m/Y"|default:"-" }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                         <!-- 5. PUBLICIDAD -->
                         <div class="card shadow-sm border flex-grow-1">
                             <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small d-flex justify-content-between align-items-center">
                                <div><i class="fas fa-bullhorn me-2"></i>Publicidad</div>
                                <button class="btn btn-outline-primary btn-sm py-0 px-1" style="font-size: 0.65rem;" onclick="copyPropertyDescription(this)">
                                    <i class="fas fa-copy me-1"></i>Copiar texto
                                </button>
                            </div>
                            <div class="card-body pt-0 px-2 pb-2 d-flex flex-column">
                                <div class="mb-1">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Título</label>
                                    <div class="small fw-bold text-truncate">{{ property.title }}</div>
                                </div>
                                <div class="flex-grow-1 d-flex flex-column">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Descripción</label>
                                    <div id="propertyDescriptionText" class="small text-secondary fw-normal flex-grow-1" style="overflow-y: auto;" title="{{ property.description }}">
                                        {{ property.description|default:"Sin descripción" }}
                                    </div>
                                </div>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- Subcolumna Derecha: Negociación, Ubicación, Servicios, Características -->
                <div class="col-12 col-md-6">
                    <div class="d-flex flex-column gap-2">
                        <!-- 2. NEGOCIACIÓN Y FINANZAS -->
                        <div class="card shadow-sm border">
                            <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                                <i class="fas fa-handshake me-2"></i>Negociación y Finanzas
                            </div>
                            <div class="card-body pt-0 px-2 pb-1">
                                 <div class="row g-1">
                                    <div class="col-4">
                                        <div class="p-1 border rounded bg-light bg-opacity-50 text-center">
                                            <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Com. Inicial</label>
                                            <span class="fw-bold text-success small">{{ property.initial_commission_percentage|default:"0" }}%</span>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-1 border rounded bg-light bg-opacity-50 text-center">
                                            <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Com. Final</label>
                                            <span class="fw-bold text-success small">{{ property.final_commission_percentage|default:"0" }}%</span>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-1 border rounded bg-light bg-opacity-50 text-center">
                                            <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Cierre</label>
                                            <span class="fw-bold text-dark small" style="font-size: 0.75rem;">{{ property.currency.symbol }} {{ property.final_amount|floatformat:0|default:"0" }}</span>
                                        </div>
                                    </div>
                                    <div class="col-12 border-top my-0"></div>
                                    <div class="col-6">
                                         <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Estado Negociación</label>
                                         <div class="small"><span class="badge bg-warning text-dark py-0">{{ property.negotiation_status.name|default:"-" }}</span></div>
                                    </div>
                                    <div class="col-6">
                                         <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Tipo de Contrato</label>
                                         <div class="small fw-bold text-truncate">{{ property.contract_type.name|default:"-" }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <!-- 4. UBICACIÓN -->
                         <div class="card shadow-sm border">
                             <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                                <i class="fas fa-map-marker-alt me-2"></i>Ubicación
                            </div>
                            <div class="card-body pt-0 px-2 pb-1">
                                <div class="row g-1">
                                    <div class="col-12">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.65rem;">Dirección Real</label>
                                        <div class="small text-truncate" title="{{ property.real_address }}">{{ property.real_address|default:"-" }}</div>
                                    </div>
                                    <div class="col-4">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.65rem;">Dep.</label>
                                        <div class="small text-truncate">{{ property.department_name|default:"-" }}</div>
                                    </div>
                                    <div class="col-4">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.65rem;">Prov.</label>
                                        <div class="small text-truncate">{{ property.province_name|default:"-" }}</div>
                                    </div>
                                    <div class="col-4">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.65rem;">Dist.</label>
                                        <div class="small text-truncate">{{ property.district_name|default:"-" }}</div>
                                    </div>
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.65rem;">Urbanización</label>
                                        <div class="small text-truncate">
                                            {% if is_owner_or_admin %}
                                                {{ property.urbanization_name|default:"-" }}
                                            {% else %}
                                                <span class="text-muted opacity-50" style="font-size: 0.65rem;">Vista No Autorizada</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.65rem;">Coordenadas</label>
                                        <div class="small text-monospace bg-light rounded px-1 py-0 text-truncate" style="font-size: 0.65rem;">
                                            {% if is_owner_or_admin %}
                                                {{ property.coordinates|default:"-" }}
                                            {% else %}
                                                <span class="text-muted opacity-50" style="font-size: 0.6rem;">Vista No Autorizada</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if property.google_maps_url %}
                                    <div class="col-12 text-end">
                                        <a href="{{ property.google_maps_url }}" target="_blank" class="btn btn-sm btn-link text-success p-0" style="font-size: 0.7rem; text-decoration: none;">
                                            <i class="fas fa-external-link-alt me-1"></i>Google Maps
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                             </div>
                         </div>

                         <!-- 6. SERVICIOS -->
                         <div class="card shadow-sm border">
                             <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                                <i class="fas fa-wrench me-2"></i>Servicios
                            </div>
                            <div class="card-body pt-0 px-2 pb-2">
                                <div class="row g-2">
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Agua</label>
                                        <div class="small">{{ property.water_service.name|default:"-" }}</div>
                                    </div>
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Luz</label>
                                        <div class="small">{{ property.energy_service.name|default:"-" }}</div>
                                    </div>
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Desagüe</label>
                                        <div class="small">{{ property.drainage_service.name|default:"-" }}</div>
                                    </div>
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Gas</label>
                                        <div class="small">{{ property.gas_service.name|default:"-" }}</div>
                                    </div>
                                </div>
                             </div>
                         </div>

                        <!-- 3. CARACTERÍSTICAS -->
                         <div class="card shadow-sm border">
                             <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                                <i class="fas fa-ruler-combined me-2"></i>Características
                            </div>
                            <div class="card-body pt-0 px-2 pb-1">
                                <div class="row g-1">
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">A. Terreno</label>
                                        <div class="small fw-bold">{{ property.land_area|floatformat:0 }} <span class="text-muted" style="font-size: 0.6rem;">{{ property.land_area_unit.symbol }}</span></div>
                                    </div>
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">A. Const.</label>
                                        <div class="small fw-bold">{{ property.built_area|floatformat:0 }} <span class="text-muted" style="font-size: 0.6rem;">{{ property.built_area_unit.symbol }}</span></div>
                                    </div>
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Frentera</label>
                                        <div class="small">{{ property.front_measure|default:"-" }}</div>
                                    </div>
                                    <div class="col-3 text-center">
                                        <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Fondo</label>
                                        <div class="small">{{ property.depth_measure|default:"-" }}</div>
                                    </div>
                                    
                                    <div class="col-12 border-top my-0"></div>

                                    <div class="col-4">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">½ Baños</label>
                                        <div class="small">{{ property.half_bathrooms }}</div>
                                    </div>
                                    <div class="col-4">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Pisos</label>
                                        <div class="small">{{ property.floors }}</div>
                                    </div>
                                    <div class="col-4">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Garaje</label>
                                        <div class="small text-truncate">{{ property.garage_type.name|default:"-" }}</div>
                                    </div>

                                    {% if property.parking_cost > 0 %}
                                    <div class="col-12">
                                        <div class="small text-muted fst-italic" style="font-size: 0.75rem;">Cochera: <strong>{{ property.parking_cost }}</strong> (Incl: {{ property.parking_cost_included|yesno:"Sí,No" }})</div>
                                    </div>
                                    {% endif %}
                                    {% if property.zoning %}
                                    <div class="col-12">
                                        <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Zonificación</label>
                                        <div class="small text-truncate">{{ property.zoning }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                             </div>
                         </div>
                    </div>
                </div>

                 <!-- 7. MATRIZ DE CUMPLIMIENTO DOCUMENTAL -->
                 <div class="col-12">
                     <div class="card shadow-sm border">
                         <div class="card-header bg-white fw-bold text-dark border-bottom-0 py-1 px-2 small">
                            <i class="fas fa-file-invoice me-2 text-primary"></i>Matriz de Cumplimiento Documental
                        </div>
                        <div class="card-body pt-0 px-2 pb-2">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mb-0 align-middle" style="font-size: 0.75rem;">
                                    <thead class="table-light">
                                        <tr class="text-center">
                                            {% for dt in all_document_types %}
                                                <th style="min-width: 80px;">{{ dt.name }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="text-center">
                                            {% for dt in all_document_types %}
                                                <td>
                                                    {% if dt.id in uploaded_doc_ids %}
                                                        <i class="fas fa-check-circle text-success fs-6" title="Documento cargado"></i>
                                                    {% else %}
                                                        <i class="fas fa-times-circle text-danger opacity-25"></i>
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                     </div>
                 </div>
                 <!-- ✅ Modal Confirmación Subir a WP -->
                <div class="modal fade" id="wpConfirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-cloud-upload-alt me-2"></i>Subir a WordPress</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            ¿Seguro que deseas subir esta propiedad a WordPress?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success" id="btnWpConfirmOk">
                            <i class="fas fa-check me-1"></i>Sí, subir
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- ✅ Toasts -->
                <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:11000; margin-top: 90px;">
                    <div id="wpToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                        <div class="toast-body" id="wpToastBody">...</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
                        </div>
                    </div>
                </div>

                <!-- ✅ Modal Confirmación Eliminar de WP -->
                <div class="modal fade" id="wpDeleteConfirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-danger">
                            <i class="fas fa-trash-alt me-2"></i>Eliminar de WordPress
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            ¿Seguro que deseas <strong>eliminar</strong> esta propiedad de WordPress?
                            <div class="small text-muted mt-1">Esto no se puede deshacer.</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger" id="btnWpDeleteConfirmOk">
                            <i class="fas fa-trash-alt me-1"></i>Sí, eliminar
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

<script>
function copyPropertyDescription(btn) {
    const text = document.getElementById('propertyDescriptionText').innerText;
    navigator.clipboard.writeText(text).then(() => {
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiado';
        btn.classList.replace('btn-outline-primary', 'btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.replace('btn-success', 'btn-outline-primary');
        }, 2000);
    }).catch(err => {
        console.error('Error al copiar: ', err);
    });
}
</script>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function showToast(message, variant) {
  const toastEl = document.getElementById("wpToast");
  const bodyEl = document.getElementById("wpToastBody");

  toastEl.className = "toast align-items-center border-0";
  const map = {
    success: "text-bg-success",
    danger: "text-bg-danger",
    warning: "text-bg-warning",
    info: "text-bg-info",
  };
  toastEl.classList.add(map[variant] || "text-bg-dark");

  bodyEl.textContent = message;

  const t = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 3500 });
  t.show();
}

function confirmWithModal() {
  return new Promise((resolve) => {
    const modalEl = document.getElementById("wpConfirmModal");
    const okBtn = document.getElementById("btnWpConfirmOk");
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

    const onOk = () => {
      okBtn.removeEventListener("click", onOk);
      modal.hide();
      resolve(true);
    };

    const onHidden = () => {
      modalEl.removeEventListener("hidden.bs.modal", onHidden);
      okBtn.removeEventListener("click", onOk);
      resolve(false);
    };

    okBtn.addEventListener("click", onOk);
    modalEl.addEventListener("hidden.bs.modal", onHidden);

    modal.show();
  });
}

(function () {
  const btn = document.getElementById("btnSyncWP");
  if (!btn) return;

  const originalHtml = btn.innerHTML;
  const syncUrl = btn.getAttribute("data-sync-url");
  const csrftoken = getCookie("csrftoken");

  let isLoading = false;

  btn.addEventListener("click", async () => {
    if (isLoading) return;

    const ok = await confirmWithModal();
    if (!ok) return;

    isLoading = true;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Subiendo...';

    try {
      const resp = await fetch(syncUrl, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({})
      });

      const data = await resp.json().catch(() => ({}));

      if (resp.ok) {
        showToast("✅ Subido correctamente a WordPress.", "success");
      } else {
        const msg = data.message || data.detail || "Error al subir a WordPress.";
        showToast("⚠️ " + msg, "warning");
      }
    } catch (err) {
      console.error(err);
      showToast("❌ Error de conexión. Intenta nuevamente.", "danger");
    } finally {
      isLoading = false;
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    }
  });
})();
</script>

<script>
function confirmDeleteWithModal() {
  return new Promise((resolve) => {
    const modalEl = document.getElementById("wpDeleteConfirmModal");
    const okBtn = document.getElementById("btnWpDeleteConfirmOk");
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

    const onOk = () => {
      okBtn.removeEventListener("click", onOk);
      modal.hide();
      resolve(true);
    };

    const onHidden = () => {
      modalEl.removeEventListener("hidden.bs.modal", onHidden);
      okBtn.removeEventListener("click", onOk);
      resolve(false);
    };

    okBtn.addEventListener("click", onOk);
    modalEl.addEventListener("hidden.bs.modal", onHidden);

    modal.show();
  });
}

(function () {
  const btn = document.getElementById("btnDeleteWP");
  if (!btn) return;

  const originalHtml = btn.innerHTML;
  const deleteUrl = btn.getAttribute("data-delete-url");
  const csrftoken = getCookie("csrftoken");

  let isLoading = false;

  btn.addEventListener("click", async () => {
    if (isLoading) return;

    const ok = await confirmDeleteWithModal();
    if (!ok) return;

    isLoading = true;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Eliminando...';

    try {
      const resp = await fetch(deleteUrl + "?force=true", {
        method: "DELETE",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        }
      });

      const data = await resp.json().catch(() => ({}));

      if (resp.ok) {
        // Si tu service devuelve algo como {ok:true, deleted:true/false, message:"..."} lo usamos
        if (data.deleted === false || data.not_found === true) {
          showToast("⚠️ Tu propiedad no está subida en WP.", "warning");
        } else {
          showToast("✅ Eliminado correctamente de WordPress.", "success");
        }
      } else {
        const msg = data.message || data.detail || "Error al eliminar de WordPress.";
        // caso típico: si backend responde 404 o 400 por no existir
        if ((resp.status === 404) || (typeof msg === "string" && msg.toLowerCase().includes("not found"))) {
          showToast("⚠️ Tu propiedad no está subida en WP.", "warning");
        } else {
          showToast("❌ " + msg, "danger");
        }
      }
    } catch (err) {
      console.error(err);
      showToast("❌ Error de conexión. Intenta nuevamente.", "danger");
    } finally {
      isLoading = false;
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    }
  });
})();
</script>