{% extends 'properties/base_dashboard.html' %}
{% load static %}

{% extends 'properties/base_dashboard.html' %}
{% load static %}

{% block title %}Editar Propiedad - Janis{% endblock %}

{% block dashboard_extra_css %}
<style>
    .form-section {
        border: 1px solid #e3e6f0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        background: #fff;
        margin-bottom: 2rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .section-title {
        color: var(--color-secondary-dark);
        border-bottom: 2px solid rgba(4, 125, 125, 0.3);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .form-label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }

    .required-field::after {
        content: " *";
        color: #e74a3b;
    }

    #map {
        width: 100%;
        height: 400px;
        border: 1px solid #ddd;
        border-radius: 0.375rem;
    }

    .address-help {
        font-size: 0.875rem;
        color: #0f3f47;
        margin-top: 0.25rem;
        padding: 0.5rem;
        background-color: rgba(4, 125, 125, 0.08);
        border-left: 4px solid var(--color-primary);
        border-radius: 0.25rem;
    }

    .saving-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        z-index: 2050;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.5rem;
    }

    .media-card {
        border: 1px solid rgba(4, 125, 125, 0.2);
        border-radius: 0.75rem;
        background: #fff;
        box-shadow: 0 0.35rem 1.2rem rgba(4, 125, 125, 0.08);
        overflow: hidden;
    }

    .media-card img,
    .media-card video {
        width: 100%;
        height: 140px;
        object-fit: cover;
        display: block;
    }

    .media-card-body {
        padding: 0.75rem 1rem;
    }

    .media-card-body h6 {
        margin-bottom: 0.25rem;
    }

    .media-empty-state {
        text-align: center;
        padding: 2rem 1rem;
        border: 1px dashed rgba(4, 125, 125, 0.3);
        border-radius: 0.75rem;
        color: rgba(4, 125, 125, 0.7);
        background: rgba(4, 125, 125, 0.05);
    }

    .room-table th {
        background: rgba(4, 125, 125, 0.08);
    }

    .room-table td,
    .room-table th {
        vertical-align: middle;
    }
</style>
{% block dashboard_extra_css %}
<style>
    /* Restaurar estilos antiguos aquí */
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <a href="{% url 'properties:detail' object.pk %}" class="btn btn-outline-secondary btn-sm me-2">
                <i class="fas fa-arrow-left me-1"></i>Volver al detalle
            </a>
            <a href="{% url 'properties:list' %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-list me-1"></i>Listado de propiedades
            </a>
        </div>
        <div class="text-end">
            <p class="text-muted mb-1">Código interno: <strong>{{ object.code }}</strong></p>
            {% if object.codigo_unico_propiedad %}
            <p class="text-muted mb-0">Código único propiedad: <strong>{{ object.codigo_unico_propiedad }}</strong></p>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-xl-3 order-xl-2 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Propietario</h5>
                </div>
                <div class="card-body">
                    <h6 class="fw-semibold mb-1">{{ owner.full_name }}</h6>
                    <p class="text-muted small mb-3">Documento: {{ owner.identity_document }}</p>

                    <div class="mb-2">
                        <span class="text-muted d-block small">Teléfono</span>
                        <span class="fw-semibold">{{ owner.phone }}</span>
                    </div>
                    {% if owner.secondary_phone %}
                    <div class="mb-2">
                        <span class="text-muted d-block small">Teléfono secundario</span>
                        <span class="fw-semibold">{{ owner.secondary_phone }}</span>
                    </div>
                    {% endif %}
                    <div class="mb-2">
                        <span class="text-muted d-block small">Correo</span>
                        <a href="mailto:{{ owner.email }}" class="fw-semibold">{{ owner.email }}</a>
                    </div>
                    <hr>
                    <div class="d-grid gap-2">
                        <a href="{% url 'properties:contact_detail' owner.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>Ver contacto
                        </a>
                        <a href="{% url 'properties:contact_edit' owner.pk %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-user-edit me-1"></i>Editar contacto
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-9 order-xl-1">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Editar Propiedad
                    </h4>
                    <p class="mb-0 mt-1 small opacity-75">Actualiza la información comercial y multimedia de la propiedad.</p>
                </div>
                <div class="card-body">
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <form method="POST" enctype="multipart/form-data" id="propertyForm">
                        {% csrf_token %}

                        <!-- Información básica -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-home me-2"></i>Información Básica
                            </h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Responsable de la propiedad</label>
                                    {{ form.responsible }}
                                    {{ form.responsible.errors }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">Estado</label>
                                    {{ form.status }}
                                    {{ form.status.errors }}
                                    <div id="antiquityFields" class="mt-3 d-none">
                                        <label class="form-label required-field">Años de antigüedad</label>
                                        {{ form.antiquity_years }}
                                        {{ form.antiquity_years.errors }}
                                        <small class="form-text text-muted">Requerido si el estado corresponde a propiedades usadas.</small>
                                    </div>
                                    <div id="deliveryFields" class="mt-3 d-none">
                                        <label class="form-label required-field">Fecha estimada de entrega</label>
                                        {{ form.delivery_date }}
                                        {{ form.delivery_date.errors }}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">Tipo</label>
                                    {{ form.property_type }}
                                    {{ form.property_type.errors }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required-field">Subtipo</label>
                                    {{ form.property_subtype }}
                                    {{ form.property_subtype.errors }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label required-field">Precio</label>
                                    {{ form.price }}
                                    {{ form.price.errors }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label required-field">Moneda</label>
                                    {{ form.currency }}
                                    {{ form.currency.errors }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="form-check form-switch mt-4">
                                        {{ form.has_maintenance }}
                                        <label class="form-check-label">Incluye mantenimiento</label>
                                    </div>
                                    {{ form.has_maintenance.errors }}
                                </div>
                            </div>
                        </div>

                        <!-- Información financiera -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-handshake me-2"></i>Negociación y Finanzas
                            </h5>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Comisión inicial (%)</label>
                                    {{ financial_form.initial_commission_percentage }}
                                    {{ financial_form.initial_commission_percentage.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Comisión final (%)</label>
                                    {{ financial_form.final_commission_percentage }}
                                    {{ financial_form.final_commission_percentage.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Monto final negociado</label>
                                    {{ financial_form.final_amount }}
                                    {{ financial_form.final_amount.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Estado de negociación</label>
                                    {{ financial_form.negotiation_status }}
                                    {{ financial_form.negotiation_status.errors }}
                                </div>
                            </div>

                            <p class="text-muted small mb-0">Solo se mostrarán los valores completados en el detalle de la propiedad.</p>
                        </div>

                        <!-- Publicidad -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-bullhorn me-2"></i>Publicidad y Redes
                            </h5>

                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Título descriptivo</label>
                                    {{ form.title }}
                                    {{ form.title.errors }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Descripción detallada</label>
                                    {{ form.description }}
                                    {{ form.description.errors }}
                                </div>
                            </div>
                        </div>

                        <!-- Características -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-ruler-combined me-2"></i>Características
                            </h5>

                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Dormitorios</label>
                                    {{ form.bedrooms }}
                                    {{ form.bedrooms.errors }}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Baños</label>
                                    {{ form.bathrooms }}
                                    {{ form.bathrooms.errors }}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Medios baños</label>
                                    {{ form.half_bathrooms }}
                                    {{ form.half_bathrooms.errors }}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Pisos</label>
                                    {{ form.floors }}
                                    {{ form.floors.errors }}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Estacionamientos</label>
                                    {{ form.garage_spaces }}
                                    {{ form.garage_spaces.errors }}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Tipo garaje</label>
                                    {{ form.garage_type }}
                                    {{ form.garage_type.errors }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Área terreno</label>
                                    {{ form.land_area }}
                                    {{ form.land_area.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Unidad</label>
                                    {{ form.land_area_unit }}
                                    {{ form.land_area_unit.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Área construida</label>
                                    {{ form.built_area }}
                                    {{ form.built_area.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Unidad</label>
                                    {{ form.built_area_unit }}
                                    {{ form.built_area_unit.errors }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Frente (m)</label>
                                    {{ form.front_measure }}
                                    {{ form.front_measure.errors }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Profundidad (m)</label>
                                    {{ form.depth_measure }}
                                    {{ form.depth_measure.errors }}
                                </div>
                            </div>
                        </div>

                        <!-- Servicios -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-wrench me-2"></i>Servicios Públicos
                            </h5>

                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Actualiza el tipo de conexión disponible para cada servicio.
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Agua</label>
                                    {{ form.water_service }}
                                    {{ form.water_service.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Energía eléctrica</label>
                                    {{ form.energy_service }}
                                    {{ form.energy_service.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Drenaje</label>
                                    {{ form.drainage_service }}
                                    {{ form.drainage_service.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Gas</label>
                                    {{ form.gas_service }}
                                    {{ form.gas_service.errors }}
                                </div>
                            </div>
                        </div>

                        <!-- Ubicación -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-map-marker-alt me-2"></i>Ubicación
                            </h5>

                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label">Dirección real (documentos)</label>
                                    {{ form.real_address }}
                                    {{ form.real_address.errors }}
                                    <div class="address-help">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Usa la dirección exacta que figura en escrituras y documentos notariales.
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-lg-6">
                                    <label class="form-label">Dirección para mapa</label>
                                    {{ form.exact_address }}
                                    {{ form.exact_address.errors }}
                                </div>
                                <div class="col-lg-6">
                                    <label class="form-label">Coordenadas (lat, long)</label>
                                    {{ form.coordinates }}
                                    {{ form.coordinates.errors }}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label required-field">Departamento</label>
                                    <select class="form-select" name="department" id="id_department"
                                            data-selected="{{ selected_department_id }}"
                                            data-selected-name="{{ selected_department_name }}">
                                        <option value="">-- Seleccionar departamento --</option>
                                        {% for dept in departments %}
                                        <option value="{{ dept.id }}" {% if dept.id|stringformat:'s' == selected_department_id|stringformat:'s' or dept.name == selected_department_name %}selected{% endif %}>{{ dept.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label required-field">Provincia</label>
                                    <select class="form-select" name="province" id="id_province"
                                            data-selected="{{ selected_province_id }}"
                                            data-selected-name="{{ selected_province_name }}">
                                        <option value="">{% if selected_province_name %}{{ selected_province_name }}{% else %}-- Seleccionar provincia --{% endif %}</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label required-field">Distrito</label>
                                    <select class="form-select" name="district" id="id_district"
                                            data-selected="{{ selected_district_id }}"
                                            data-selected-name="{{ selected_district_name }}">
                                        <option value="">{% if selected_district_name %}{{ selected_district_name }}{% else %}-- Seleccionar distrito --{% endif %}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Urbanización</label>
                                    <select class="form-select" name="urbanization" id="id_urbanization"
                                            data-selected="{{ selected_urbanization_id }}"
                                            data-selected-name="{{ selected_urbanization_name }}">
                                        <option value="">{% if selected_urbanization_name %}{{ selected_urbanization_name }}{% else %}-- Seleccionar urbanización --{% endif %}</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <div class="d-flex gap-2 align-items-end">
                                        <button type="button" class="btn btn-outline-primary" id="searchOnMap">
                                            <i class="fas fa-search-location me-1"></i>Buscar en mapa
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="getCurrentLocation">
                                            <i class="fas fa-crosshairs me-1"></i>Usar mi ubicación
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-12">
                                    <div id="map"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Amenidades</label>
                                    {{ form.amenities }}
                                    {{ form.amenities.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Zonificación</label>
                                    {{ form.zoning }}
                                    {{ form.zoning.errors }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Etiquetas</label>
                                    {{ form.tags }}
                                    {{ form.tags.errors }}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Guardar cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestión de medios -->
    <div class="row mt-4">
        <div class="col-xl-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-images me-2"></i>Imágenes</h5>
                    <span class="badge bg-primary">{{ existing_images|length }}</span>
                </div>
                <div class="card-body">
                    {% if existing_images %}
                    <div class="media-grid mb-4">
                        {% for image in existing_images %}
                        <div class="media-card">
                            {% if image.image %}
                            <img src="{{ image.image.url }}" alt="{{ image.caption }}">
                            {% endif %}
                            <div class="media-card-body">
                                <h6 class="mb-0">{{ image.image_type.name }}</h6>
                                {% if image.image_ambiente %}
                                <p class="text-muted small mb-1">Ambiente: {{ image.image_ambiente.name }}</p>
                                {% endif %}
                                {% if image.caption %}
                                <p class="small mb-0">{{ image.caption }}</p>
                                {% endif %}
                                <small class="text-muted d-block mt-1">Orden: {{ image.order }}</small>
                                {% if image.is_primary %}
                                <span class="badge bg-success mt-2">Principal</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="media-empty-state mb-4">
                        <i class="fas fa-image fa-2x mb-2"></i>
                        <p class="mb-0">Aún no se han cargado imágenes.</p>
                    </div>
                    {% endif %}

                    <h6 class="fw-semibold">Agregar nueva imagen</h6>
                    <form method="POST" enctype="multipart/form-data" action="{% url 'properties:add_image' object.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ redirect_path }}">
                        <div class="mb-3">
                            <label class="form-label">Archivo</label>
                            {{ image_form.image }}
                            {{ image_form.image.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            {{ image_form.image_type }}
                            {{ image_form.image_type.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ambiente</label>
                            <select class="form-select" name="image_ambientes">
                                <option value="">Seleccionar ambiente</option>
                                {% for room_type in room_types %}
                                <option value="{{ room_type.id }}">{{ room_type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            {{ image_form.caption }}
                            {{ image_form.caption.errors }}
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Orden</label>
                                {{ image_form.order }}
                                {{ image_form.order.errors }}
                            </div>
                            <div class="col-6 d-flex align-items-center">
                                <div class="form-check mt-3">
                                    {{ image_form.is_primary }}
                                    <label class="form-check-label">Principal</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="fas fa-upload me-1"></i>Guardar imagen
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-video me-2"></i>Videos</h5>
                    <span class="badge bg-primary">{{ existing_videos|length }}</span>
                </div>
                <div class="card-body">
                    {% if existing_videos %}
                    <div class="media-grid mb-4">
                        {% for video in existing_videos %}
                        <div class="media-card">
                            <video controls preload="metadata">
                                <source src="{{ video.video.url }}">
                                Tu navegador no soporta video.
                            </video>
                            <div class="media-card-body">
                                <h6 class="mb-0">{{ video.title }}</h6>
                                <p class="text-muted small mb-1">{{ video.video_type.name }}</p>
                                {% if video.description %}
                                <p class="small mb-0">{{ video.description }}</p>
                                {% endif %}
                                <small class="text-muted d-block mt-1">{{ video.uploaded_at|date:"d/m/Y H:i" }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="media-empty-state mb-4">
                        <i class="fas fa-video-slash fa-2x mb-2"></i>
                        <p class="mb-0">Aún no se han cargado videos.</p>
                    </div>
                    {% endif %}

                    <h6 class="fw-semibold">Agregar nuevo video</h6>
                    <form method="POST" enctype="multipart/form-data" action="{% url 'properties:add_video' object.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ redirect_path }}">
                        <div class="mb-3">
                            <label class="form-label">Archivo</label>
                            {{ video_form.video }}
                            {{ video_form.video.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            {{ video_form.video_type }}
                            {{ video_form.video_type.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            {{ video_form.title }}
                            {{ video_form.title.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            {{ video_form.description }}
                            {{ video_form.description.errors }}
                        </div>
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="fas fa-upload me-1"></i>Guardar video
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Documentos</h5>
                    <span class="badge bg-primary">{{ existing_documents|length }}</span>
                </div>
                <div class="card-body">
                    {% if existing_documents %}
                    <div class="list-group list-group-flush mb-4">
                        {% for document in existing_documents %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ document.title }}</h6>
                                    <p class="text-muted small mb-1">{{ document.document_type.name }}</p>
                                    {% if document.description %}
                                    <p class="small mb-0">{{ document.description }}</p>
                                    {% endif %}
                                </div>
                                <a class="btn btn-outline-primary btn-sm" href="{{ document.file.url }}" download>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="media-empty-state mb-4">
                        <i class="fas fa-file fa-2x mb-2"></i>
                        <p class="mb-0">No hay documentos registrados.</p>
                    </div>
                    {% endif %}

                    <h6 class="fw-semibold">Agregar nuevo documento</h6>
                    <form method="POST" enctype="multipart/form-data" action="{% url 'properties:add_document' object.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ redirect_path }}">
                        <div class="mb-3">
                            <label class="form-label">Archivo</label>
                            {{ document_form.file }}
                            {{ document_form.file.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            {{ document_form.document_type }}
                            {{ document_form.document_type.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            {{ document_form.title }}
                            {{ document_form.title.errors }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            {{ document_form.description }}
                            {{ document_form.description.errors }}
                        </div>
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="fas fa-upload me-1"></i>Guardar documento
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ambientes -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Ambientes registrados</h5>
        </div>
        <div class="card-body">
            {% if rooms %}
            <div class="table-responsive">
                <table class="table table-striped room-table align-middle">
                    <thead>
                        <tr>
                            <th>Orden</th>
                            <th>Nivel</th>
                            <th>Tipo</th>
                            <th>Nombre</th>
                            <th>Dimensiones</th>
                            <th>Piso</th>
                            <th>Descripción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for room in rooms %}
                        <tr>
                            <td>{{ room.order }}</td>
                            <td>{% if room.level %}{{ room.level.name }}{% else %}N/A{% endif %}</td>
                            <td>{% if room.room_type %}{{ room.room_type.name }}{% else %}N/A{% endif %}</td>
                            <td>{{ room.name|default:'N/A' }}</td>
                            <td>
                                {% if room.width and room.length %}
                                    {{ room.width }}m x {{ room.length }}m
                                {% elif room.area %}
                                    {{ room.area }} m²
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{% if room.floor_type %}{{ room.floor_type.name }}{% else %}N/A{% endif %}</td>
                            <td>{{ room.description|default:'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="media-empty-state">
                <i class="fas fa-door-open fa-2x mb-2"></i>
                <p class="mb-0">Aún no se han registrado ambientes.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="saving-overlay d-none" id="savingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Guardando...</span>
        </div>
        <p class="fw-semibold text-primary mb-0">Guardando cambios, espera un momento...</p>
    </div>
</div>
{% block dashboard_content %}
<div class="container-fluid py-4">
    <!-- ...restaurar el contenido y estilos antiguos... -->
</div>
{% endblock %}

{% block dashboard_extra_js %}
{{ statuses_data|json_script:"statusMetadata" }}
<script>
let map;
let marker;
let autocomplete;
let geocoder;

function initMap() {
    geocoder = new google.maps.Geocoder();
    const defaultCenter = { lat: -12.046374, lng: -77.042793 };

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: defaultCenter,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true,
        styles: [
            { "featureType": "poi.business", "stylers": [{ "visibility": "off" }] },
            { "featureType": "poi.medical", "stylers": [{ "visibility": "off" }] },
            { "featureType": "poi.school", "stylers": [{ "visibility": "off" }] },
            { "featureType": "transit", "stylers": [{ "visibility": "simplified" }] }
        ]
    });

    marker = new google.maps.Marker({
        position: defaultCenter,
        map: map,
        draggable: true,
        title: 'Arrastra para ajustar la ubicación',
        icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 0C12.268 0 6 6.268 6 14C6 24.5 20 40 20 40C20 40 34 24.5 34 14C34 6.268 27.732 0 20 0Z" fill="#047d7d"/>
                    <circle cx="20" cy="14" r="6" fill="white"/>
                </svg>
            `),
            scaledSize: new google.maps.Size(40, 40),
            anchor: new google.maps.Point(20, 40)
        }
    });

    const addressInput = document.getElementById('id_exact_address');
    autocomplete = new google.maps.places.Autocomplete(addressInput, {
        types: ['address'],
        componentRestrictions: { country: 'pe' },
        fields: ['address_components', 'geometry', 'formatted_address']
    });

    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            alert("No se encontraron detalles para: '" + place.name + "'");
            return;
        }

        map.setCenter(place.geometry.location);
        map.setZoom(16);
        marker.setPosition(place.geometry.location);
        updateCoordinates(place.geometry.location);
        fillLocationFields(place);
    });

    marker.addListener('dragend', function() {
        updateCoordinates(marker.getPosition());
        reverseGeocode(marker.getPosition());
    });

    map.addListener('click', function(event) {
        marker.setPosition(event.latLng);
        updateCoordinates(event.latLng);
        reverseGeocode(event.latLng);
    });

    document.getElementById('searchOnMap').addEventListener('click', function() {
        const address = addressInput.value;
        if (address) {
            geocodeAddress(address);
        } else {
            alert('Ingresa una dirección para buscar en el mapa.');
        }
    });

    document.getElementById('getCurrentLocation').addEventListener('click', function() {
        getCurrentLocation();
    });

    const coordsInput = document.getElementById('id_coordinates');
    if (coordsInput && coordsInput.value) {
        const coords = coordsInput.value.split(',');
        if (coords.length === 2) {
            const lat = parseFloat(coords[0].trim());
            const lng = parseFloat(coords[1].trim());
            if (!isNaN(lat) && !isNaN(lng)) {
                const position = { lat: lat, lng: lng };
                marker.setPosition(position);
                map.setCenter(position);
                map.setZoom(16);
            }
        }
    }
}

function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalización.');
        return;
    }

    navigator.geolocation.getCurrentPosition(function(position) {
        const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };
        marker.setPosition(pos);
        map.setCenter(pos);
        map.setZoom(16);
        updateCoordinates(pos);
        reverseGeocode(pos);
    }, function(error) {
        let message = 'Error al obtener la ubicación actual: ';
        switch (error.code) {
            case error.PERMISSION_DENIED:
                message += 'Permiso denegado por el usuario.';
                break;
            case error.POSITION_UNAVAILABLE:
                message += 'Información de ubicación no disponible.';
                break;
            case error.TIMEOUT:
                message += 'Tiempo de espera agotado.';
                break;
            default:
                message += 'Error desconocido.';
        }
        alert(message);
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
}

function updateCoordinates(latLng) {
    const coordsInput = document.getElementById('id_coordinates');
    if (!coordsInput) {
        return;
    }

    if (typeof latLng.lat === 'function') {
        coordsInput.value = latLng.lat().toFixed(6) + ', ' + latLng.lng().toFixed(6);
    } else {
        coordsInput.value = latLng.lat.toFixed(6) + ', ' + latLng.lng.toFixed(6);
    }
}

function geocodeAddress(address) {
    geocoder.geocode({ address: address }, function(results, status) {
        if (status === 'OK' && results[0]) {
            map.setCenter(results[0].geometry.location);
            map.setZoom(16);
            marker.setPosition(results[0].geometry.location);
            updateCoordinates(results[0].geometry.location);
            fillLocationFields(results[0]);
        } else {
            alert('No se pudo encontrar la dirección proporcionada.');
        }
    });
}

function reverseGeocode(latLng) {
    geocoder.geocode({ location: latLng }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const addressInput = document.getElementById('id_exact_address');
            if (addressInput) {
                addressInput.value = results[0].formatted_address;
            }
        }
    });
}

function fillLocationFields(place) {
    const departmentSelect = document.getElementById('id_department');
    const provinceSelect = document.getElementById('id_province');
    const districtSelect = document.getElementById('id_district');

    if (!departmentSelect || departmentSelect.value) {
        return;
    }

    let departmentName = '';
    let provinceName = '';
    let districtName = '';

    (place.address_components || []).forEach(component => {
        if (!component.types) {
            return;
        }
        if (component.types.includes('administrative_area_level_1')) {
            departmentName = component.long_name;
        } else if (component.types.includes('administrative_area_level_2')) {
            provinceName = component.long_name;
        } else if (component.types.includes('sublocality_level_1') || component.types.includes('administrative_area_level_3')) {
            districtName = component.long_name;
        }
    });

    if (departmentName) {
        const deptOption = Array.from(departmentSelect.options).find(opt => opt.text.toLowerCase().includes(departmentName.toLowerCase()));
        if (deptOption) {
            departmentSelect.value = deptOption.value;
            departmentSelect.dispatchEvent(new Event('change'));
        }
    }

    if (provinceName) {
        provinceSelect.dataset.selectedName = provinceName;
    }
    if (districtName) {
        districtSelect.dataset.selectedName = districtName;
    }
}

function setupStatusSection() {
    const statusSelect = document.getElementById('id_status');
    const antiquityRow = document.getElementById('antiquityFields');
    const deliveryRow = document.getElementById('deliveryFields');
    const antiquityInput = document.getElementById('id_antiquity_years');
    const deliveryInput = document.getElementById('id_delivery_date');
    const statusDataElement = document.getElementById('statusMetadata');

    if (!statusSelect) {
        return;
    }

    const statusMap = {};
    if (statusDataElement) {
        try {
            const statuses = JSON.parse(statusDataElement.textContent || '[]');
            statuses.forEach(function(item) {
                if (!item || typeof item.id === 'undefined') {
                    return;
                }
                const idKey = String(item.id);
                const normalizedCode = normalizeValue(item.code);
                const normalizedName = normalizeValue(item.name);
                statusMap[idKey] = normalizedCode || normalizedName;
            });
        } catch (error) {
            console.warn('No se pudo procesar la metadata de estados', error);
        }
    }

    const antiquityAliases = ['antiguedad', 'antiquity', 'anosantiguedad'];
    const constructionAliases = ['enconstruccion', 'enconstruction', 'underconstruction', 'construccion'];

    function normalizeValue(value) {
        if (!value) {
            return '';
        }
        return String(value).toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function matchesAlias(value, aliases) {
        if (!value) {
            return false;
        }
        return aliases.some(function(alias) {
            if (!alias) {
                return false;
            }
            return value === alias || value.includes(alias) || alias.includes(value);
        });
    }

    function toggleStatusFields() {
        const selectedValue = statusSelect.value;
        const option = statusSelect.options[statusSelect.selectedIndex];
        const normalizedFallback = normalizeValue(option ? option.text : '');
        const normalizedStatus = statusMap[selectedValue] || normalizedFallback;

        const showAntiquity = matchesAlias(normalizedStatus, antiquityAliases);
        const showDelivery = matchesAlias(normalizedStatus, constructionAliases);

        if (antiquityRow) {
            antiquityRow.classList.toggle('d-none', !showAntiquity);
        }
        if (deliveryRow) {
            deliveryRow.classList.toggle('d-none', !showDelivery);
        }

        if (!showAntiquity && antiquityInput) {
            antiquityInput.value = '';
        }
        if (!showDelivery && deliveryInput) {
            deliveryInput.value = '';
        }
    }

    statusSelect.addEventListener('change', toggleStatusFields);
    toggleStatusFields();
}

function setupSubtypeSelector() {
    const propertyTypeSelect = document.getElementById('id_property_type');
    const propertySubtypeSelect = document.getElementById('id_property_subtype');
    if (!propertyTypeSelect || !propertySubtypeSelect) {
        return;
    }

    const initialSubtype = propertySubtypeSelect.dataset.selected || propertySubtypeSelect.value;

    function loadPropertySubtypes(propertyTypeId, selectedSubtypeId) {
        if (!propertyTypeId) {
            propertySubtypeSelect.innerHTML = '<option value="">Seleccione un subtipo</option>';
            propertySubtypeSelect.disabled = true;
            return;
        }

        fetch(`/properties/api/property-subtypes/?property_type_id=${propertyTypeId}`)
            .then(response => response.json())
            .then(data => {
                propertySubtypeSelect.innerHTML = '<option value="">Seleccione un subtipo</option>';
                const subtypes = Array.isArray(data) ? data : (data.subtypes || []);
                subtypes.forEach(subtype => {
                    const option = document.createElement('option');
                    option.value = subtype.id;
                    option.textContent = subtype.name;
                    if (selectedSubtypeId && String(subtype.id) === String(selectedSubtypeId)) {
                        option.selected = true;
                    }
                    propertySubtypeSelect.appendChild(option);
                });
                propertySubtypeSelect.disabled = false;
            })
            .catch(() => {
                propertySubtypeSelect.innerHTML = '<option value="">Error al cargar subtipos</option>';
                propertySubtypeSelect.disabled = false;
            });
    }

    propertyTypeSelect.addEventListener('change', function() {
        loadPropertySubtypes(this.value, null);
    });

    if (propertyTypeSelect.value) {
        loadPropertySubtypes(propertyTypeSelect.value, initialSubtype);
    } else {
        propertySubtypeSelect.disabled = true;
    }
}

function setupLocationSelectors() {
    const departmentSelect = document.getElementById('id_department');
    const provinceSelect = document.getElementById('id_province');
    const districtSelect = document.getElementById('id_district');
    const urbanizationSelect = document.getElementById('id_urbanization');

    if (!departmentSelect || !provinceSelect || !districtSelect || !urbanizationSelect) {
        return;
    }

    const selectedDepartmentId = departmentSelect.dataset.selected;
    const selectedProvinceId = provinceSelect.dataset.selected;
    const selectedProvinceName = provinceSelect.dataset.selectedName;
    const selectedDistrictId = districtSelect.dataset.selected;
    const selectedDistrictName = districtSelect.dataset.selectedName;
    const selectedUrbanizationId = urbanizationSelect.dataset.selected;
    const selectedUrbanizationName = urbanizationSelect.dataset.selectedName;

    function populateSelect(select, options, placeholder, selectedValue, selectedName) {
        select.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = placeholder;
        select.appendChild(defaultOption);

        options.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            if ((selectedValue && String(item.id) === String(selectedValue)) || (selectedName && item.name === selectedName)) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        select.disabled = options.length === 0;
    }

    function loadProvinces(departmentId, selectedId, selectedName) {
        if (!departmentId) {
            populateSelect(provinceSelect, [], '-- Seleccionar provincia --', null, null);
            populateSelect(districtSelect, [], '-- Seleccionar distrito --', null, null);
            populateSelect(urbanizationSelect, [], '-- Seleccionar urbanización --', null, null);
            districtSelect.disabled = true;
            urbanizationSelect.disabled = true;
            return;
        }

        provinceSelect.classList.add('loading');
        fetch(`/properties/api/provinces/?department_id=${departmentId}`)
            .then(response => response.json())
            .then(data => {
                populateSelect(provinceSelect, data, '-- Seleccionar provincia --', selectedId, selectedName);
                provinceSelect.classList.remove('loading');
                if (selectedId || selectedName) {
                    const value = provinceSelect.value;
                    if (value) {
                        loadDistricts(value, selectedDistrictId, selectedDistrictName);
                    }
                }
            })
            .catch(() => {
                provinceSelect.classList.remove('loading');
                populateSelect(provinceSelect, [], 'Error al cargar provincias', null, null);
            });
    }

    function loadDistricts(provinceId, selectedId, selectedName) {
        if (!provinceId) {
            populateSelect(districtSelect, [], '-- Seleccionar distrito --', null, null);
            populateSelect(urbanizationSelect, [], '-- Seleccionar urbanización --', null, null);
            urbanizationSelect.disabled = true;
            return;
        }

        districtSelect.classList.add('loading');
        fetch(`/properties/api/districts/?province_id=${provinceId}`)
            .then(response => response.json())
            .then(data => {
                populateSelect(districtSelect, data, '-- Seleccionar distrito --', selectedId, selectedName);
                districtSelect.classList.remove('loading');
                if (selectedId || selectedName) {
                    const value = districtSelect.value;
                    if (value) {
                        loadUrbanizations(value, selectedUrbanizationId, selectedUrbanizationName);
                    }
                }
            })
            .catch(() => {
                districtSelect.classList.remove('loading');
                populateSelect(districtSelect, [], 'Error al cargar distritos', null, null);
            });
    }

    function loadUrbanizations(districtId, selectedId, selectedName) {
        if (!districtId) {
            populateSelect(urbanizationSelect, [], '-- Seleccionar urbanización --', null, null);
            return;
        }

        urbanizationSelect.classList.add('loading');
        fetch(`/properties/api/urbanizations/?district_id=${districtId}`)
            .then(response => response.json())
            .then(data => {
                populateSelect(urbanizationSelect, data, '-- Seleccionar urbanización --', selectedId, selectedName);
                urbanizationSelect.classList.remove('loading');
            })
            .catch(() => {
                urbanizationSelect.classList.remove('loading');
                populateSelect(urbanizationSelect, [], 'Error al cargar urbanizaciones', null, null);
            });
    }

    departmentSelect.addEventListener('change', function() {
        loadProvinces(this.value, null, null);
    });

    provinceSelect.addEventListener('change', function() {
        loadDistricts(this.value, null, null);
    });

    districtSelect.addEventListener('change', function() {
        loadUrbanizations(this.value, null, null);
    });

    if (selectedDepartmentId) {
        departmentSelect.value = selectedDepartmentId;
        loadProvinces(selectedDepartmentId, selectedProvinceId, selectedProvinceName);
    } else {
        provinceSelect.disabled = true;
        districtSelect.disabled = true;
        urbanizationSelect.disabled = true;
    }

    if (selectedDepartmentId && !selectedProvinceId && selectedProvinceName) {
        provinceSelect.dataset.selectedName = selectedProvinceName;
    }
    if (selectedProvinceId && !selectedDistrictId && selectedDistrictName) {
        districtSelect.dataset.selectedName = selectedDistrictName;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setupStatusSection();
    setupSubtypeSelector();
    setupLocationSelectors();

    const propertyForm = document.getElementById('propertyForm');
    const savingOverlay = document.getElementById('savingOverlay');

    if (propertyForm && savingOverlay) {
        propertyForm.addEventListener('submit', function(event) {
            if (typeof propertyForm.checkValidity === 'function' && !propertyForm.checkValidity()) {
                event.preventDefault();
                propertyForm.reportValidity();
                return;
            }

            if (savingOverlay.classList.contains('d-none')) {
                savingOverlay.classList.remove('d-none');
            }

            const submitBtn = propertyForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando...';
            }
        });
    }
});

window.gm_authFailure = function() {
    alert('Error de autenticación con Google Maps. Verifica tu API key.');
};

function gm_error() {
    alert('Error al cargar Google Maps API. Verifica tu conexión y la API key.');
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrL1QF7vTl9zF8FmCUumfRpFJcaYokO7Q&libraries=places&callback=initMap" async defer></script>
{% endblock %}
