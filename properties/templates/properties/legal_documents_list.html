{% extends 'properties/base_dashboard.html' %}

{% block dashboard_extra_css %}
<style>
    .legal-table th,
    .legal-table td {
        vertical-align: middle;
        white-space: nowrap;
    }

    .legal-table th {
      border-bottom: #e0e0e0 3px solid !important;
      padding: 1rem .75rem;
      height: 78px;
    }

    .legal-table thead th {
      position: sticky;
        top: 0;
        z-index: 3;
        background: #f8f9fa;
    }

    .legal-table thead {
        position: sticky;
        top: 0;
        z-index: 99;
      }

      .table-scroll-wrapper::before {
        content: '';
        position: sticky;
        top: 0;
        height: 1px;
        background: #f8f9fa;
        z-index: 101;
      }



    .table-scroll-wrapper {
        max-height: calc(100vh - 180px); 
        overflow-y: auto;
        position: relative;
      }


    .icon-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
    }

    .icon-btn i {
        font-size: 1.2rem;
    }

    .toggle-row i {
        transition: transform .2s ease;
    }

    tr[aria-expanded="true"] .toggle-row i {
        transform: rotate(180deg);
    }

    .doc-key {
        background: #e9f7ef; /* verde claro elegante */
    }

    .badge-doc {
        font-size: .7rem;
        margin: 0 .15rem .15rem 0;
    }
    .modal {
        z-index: 10000;
        height: 90%;
        top: 45px;

    }

    .cursor-pointer {
      cursor: pointer;
    }

    /* Component upload file */
    .upload-dropzone {
      display: block;
      border: 2px dashed #cbd5e1;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all .2s ease;
      background: #f8fafc;
    }

    .upload-dropzone:hover {
      border-color: #0d6efd;
      background: #eef4ff;
    }

    .upload-dropzone input:valid + .dropzone-content {
      color: #198754;
    }

    .legal-table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .doc-highlight {
      background-color: #e9f7ef !important; 
    }


</style>
{% endblock %}

{% block dashboard_content %}
<h3 class=" my-3">Área Legal — Documentos por Propiedad</h3>

<div class="table-scroll-wrapper">
  <table class="table table-hover align-middle legal-table">
  <thead class="table-light">
    <tr>
      <th></th>
      <th>Dirección</th>
      <th class="text-center">Título Dominio</th>
      <th class="text-center">Partida</th>
      <th class="text-center">DNI</th>
      <th class="text-center">Estudio Título</th>
      <th class="text-center">Corretaje</th>
      <th class="text-center">Otros</th>
      <th class="text-end">Avance</th>
      <th></th>
    </tr>
  </thead>

  <tbody id="legalTableBody">
    <tr>
      <td colspan="10" class="text-center text-muted py-4">
        Cargando documentos…
      </td>
    </tr>
  </tbody>
</table>
</div>




<div class="d-flex justify-content-between align-items-center mt-3">
  <button id="prevPage" class="btn btn-outline-secondary btn-sm" disabled>
    ← Anterior
  </button>

  <span id="pageInfo" class="text-muted small"></span>

  <button id="nextPage" class="btn btn-outline-secondary btn-sm" disabled>
    Siguiente →
  </button>
</div>


<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Vista previa del documento</h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="pdfFrame" src="" style="width:96%; height:80vh;" frameborder="0"></iframe>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form id="uploadForm" class="modal-content" enctype="multipart/form-data">
      <div class="modal-header">
        <h6 class="modal-title">Subir documento</h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="property_id" id="uploadPropertyId">

        <div class="mb-3">
          <label class="form-label">Tipo de documento</label>
          <select name="doc_type" class="form-select" required>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Archivo (PDF, JPG, JPEG o PNG)</label>

          <div  class="upload-dropzone">
            <div id="fileDrop">

              <i class="fas fa-cloud-upload-alt fa-2x mb-2" style="color: #44DE88;"></i>

              <div id="fileText" class="fw-semibold">
                Haz clic para seleccionar tu archivo
              </div>

              <small class="text-muted">
                PDF JPG JPEG PNG · Máx 10MB
              </small>

              <input
                type="file"
                name="file"
                id="fileInput"
                accept="application/pdf,image/jpeg,image/png"
                hidden
                required
              >
            </div>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button id="saveBtn" class="btn btn-primary" type="submit">
          Guardar
        </button>
      </div>

    </form>
  </div>
</div>

<script>
let currentPage = 1;
let nextPageUrl = null;
let prevPageUrl = null;

let DOCUMENT_TYPES_CACHE = null;

let MODAL_MODE = 'create';
let EDIT_DOC_TYPE_ID = null;

function renderOtherDocs(docs) {
  const MAIN_DOCS = [
    'Titulo_dominio',
    'Partida_registral',
    'DNI_titular',
    'Estudio_de_titulo',
    'Contrato_de_corretaje'
  ];

  const others = Object.entries(docs)
    .filter(([key, val]) => val && !MAIN_DOCS.includes(key));

  if (!others.length) {
    return `<span class="text-muted"></span>`;
  }

  return others.map(([key, url]) => `
    <span class="badge bg-secondary badge-doc"
          data-preview-url="${url}">
      ${key.replaceAll('_', ' ')}
    </span>
  `).join('');
}

async function getAllDocumentTypes(url= '/dashboard/api/document-types/') {
  const res = await fetch(url);
  const data = await res.json();
  DOCUMENT_TYPES_CACHE = data.filter(d => d.is_active);
  return DOCUMENT_TYPES_CACHE;
}


async function loadLegalDocuments(url = '/dashboard/api/properties/with-docs/') {
  const tbody = document.getElementById('legalTableBody');
  const pageInfo = document.getElementById('pageInfo');

  tbody.innerHTML = `
    <tr>
      <td colspan="10" class="text-center text-muted py-4">
        Cargando documentos…
      </td>
    </tr>
  `;

  try {
    const res = await fetch(url);
    const data = await res.json();

    window.__LEGAL_DATA__ = data.results;


    nextPageUrl = normalizeUrl(data.next);
    prevPageUrl = normalizeUrl(data.previous);

    tbody.innerHTML = '';

    data.results.forEach(p => {
      const docs = p.property_documents;
      const progress = calcProgress(docs);

      tbody.insertAdjacentHTML('beforeend', `
        <tr  id="property-row-${p.id}">
          <td></td>

          <td>
            <div class="d-flex align-items-start gap-2">

                <button
                class="btn btn-sm btn-link p-0 toggle-row"
                data-id="${p.id}"
                aria-label="Ver detalles"
                >
                <i class="fas fa-chevron-right"></i>
                </button>

                <div>
                <div class="fw-semibold text-wrap" style="max-width:248px">
                    ${p.direccion}
                </div>
                <small class="text-muted">${p.code}</small>
                </div>

            </div>
        </td>


          <td class="text-center">${docIcon(docs.Titulo_dominio)}</td>
          <td class="text-center">${docIcon(docs.Partida_registral)}</td>
          <td class="text-center">${docIcon(docs.DNI_titular)}</td>
          <td class="text-center doc-highlight">${docIcon(docs.Estudio_de_titulo)}</td>
          <td class="text-center">${docIcon(docs.Contrato_de_corretaje)}</td>
          <td class="text-center">
           <div class="d-grid">
             ${renderOtherDocs(docs)}
            </div>
          </td>


          <td class="text-end">
            <span class="badge rounded-pill bg-${
              progress === 100 ? 'success' :
              progress > 70 ? 'info' : 'warning'
            }">${progress}%</span>
          </td>

          <td class="text-center">
            <button
              class="btn btn-sm upload-btn btn-primary"
              data-property="${p.id}">
              
              <i class="fas fa-upload me-1"></i>
              <span>Subir</span>
            </button>
          </td>


        </tr>
      `);
      tbody.insertAdjacentHTML('beforeend', `
        <tr class="details-row d-none" id="details-${p.id}">
          <td colspan="10" class="bg-light">
            ${renderPropertyDetails(p)}
          </td>
        </tr>
      `);
    });

    document.getElementById('nextPage').disabled = !nextPageUrl;
    document.getElementById('prevPage').disabled = !prevPageUrl;

    pageInfo.textContent = `Página ${currentPage}`;

  } catch (e) {
    console.error(e);
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-danger text-center">
          Error cargando datos
        </td>
      </tr>
    `;
  }
}

function putStaticData(obj) {
  console.log('Putting static data', obj);
  console.log('Putting length', obj.length);
  const tbody = document.getElementById('legalTableBody');


  obj.forEach(p => {
      const docs = p.property_documents;
      const progress = calcProgress(docs);

      tbody.insertAdjacentHTML('beforeend', `
        <tr  id="property-row-${p.id}">
          <td></td>

          <td>
            <div class="d-flex align-items-start gap-2">

                <button
                class="btn btn-sm btn-link p-0 toggle-row"
                data-id="${p.id}"
                aria-label="Ver detalles"
                >
                <i class="fas fa-chevron-right"></i>
                </button>

                <div>
                <div class="fw-semibold text-wrap" style="max-width:248px">
                    ${p.direccion}
                </div>
                <small class="text-muted">${p.code}</small>
                </div>

            </div>
        </td>


          <td class="text-center">${docIcon(docs.Titulo_dominio)}</td>
          <td class="text-center">${docIcon(docs.Partida_registral)}</td>
          <td class="text-center">${docIcon(docs.DNI_titular)}</td>
          <td class="text-center">${docIcon(docs.Estudio_de_titulo)}</td>
          <td class="text-center">${docIcon(docs.Contrato_de_corretaje)}</td>
          <td class="text-center">
           <div class="d-grid">
             ${renderOtherDocs(docs)}
            </div>
          </td>


          <td class="text-end">
            <span class="badge rounded-pill bg-${
              progress === 100 ? 'success' :
              progress > 70 ? 'info' : 'warning'
            }">${progress}%</span>
          </td>

          <td class="text-center">
            <button
              class="btn btn-sm upload-btn"
              data-property="${p.id}">
              
              <i class="fas fa-upload me-1"></i>
              <span>Subir</span>
            </button>
          </td>

        </tr>
      `);
      tbody.insertAdjacentHTML('beforeend', `
        <tr class="details-row d-none" id="details-${p.id}">
          <td colspan="10" class="bg-light">
            ${renderPropertyDetails(p)}
          </td>
        </tr>
      `);
    });
}

/* helpers */

function docIcon(url) {
  if (!url) {
    return `<i class="fas fa-minus-circle text-muted opacity-50"></i>`;
  }

  // quitamos dominio y /media/
  const path = url.split('/media/')[1];

  return `
    <i class="fas fa-check-circle text-success cursor-pointer"
       data-preview-url="/media/${path}">
    </i>
  `;
}


function calcProgress(docs) {
  const total = Object.keys(docs).length;
  const present = Object.values(docs).filter(Boolean).length;
  return Math.round((present / total) * 100);
}

/* paginación */

document.getElementById('nextPage').addEventListener('click', () => {
  if (!nextPageUrl) return;
  currentPage++;
  loadLegalDocuments(nextPageUrl);
});

document.getElementById('prevPage').addEventListener('click', () => {
  if (!prevPageUrl) return;
  currentPage--;
  loadLegalDocuments(prevPageUrl);
});


/* abrir PDF en nueva pestaña */

document.addEventListener('click', function (e) {
  const el = e.target.closest('[data-preview-url]');
  if (!el) return;

  const url = el.dataset.previewUrl;

  window.open(url, '_blank', 'noopener,noreferrer');
});


/* init */

document.addEventListener('DOMContentLoaded', () => {
  loadLegalDocuments();
  getAllDocumentTypes();
  new bootstrap.Tooltip(document.body, {
    selector: '[data-bs-toggle="tooltip"]'
  });
});

function normalizeUrl(url) {
  if (!url) return null;

  // Si viene http en producción, lo forzamos a https
  if (location.protocol === 'https:' && url.startsWith('http://')) {
    return url.replace('http://', 'https://');
  }

  return url;
}


/* Open modal */
document.addEventListener('click', async e => {
  const btn = e.target.closest('.upload-btn');
  if (!btn) return;

  const propertyId = btn.dataset.property;

  document.getElementById('uploadPropertyId').value = propertyId;
  document.getElementById('uploadForm').reset();
  document.getElementById('fileInput').value = '';

  const property = window.__LEGAL_DATA__.find(p => p.id == propertyId);

  await populateDocTypeSelect(property.property_documents, property.can_legal_upload_study);

  const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
  modal.show();
});

document.addEventListener('DOMContentLoaded', () => {
  const uploadModalEl = document.getElementById('uploadModal');
  const uploadForm = document.getElementById('uploadForm');
  const fileInput = document.getElementById('fileInput');
  const fileText = document.getElementById('fileText');

  if (!uploadModalEl) return;

  uploadModalEl.addEventListener('show.bs.modal', () => {
    uploadForm.reset();
    fileInput.value = '';
    fileText.textContent = 'Arrastra tu archivo aquí o haz clic para seleccionar';
  });
});



/* Send media */
document.getElementById('uploadForm').addEventListener('submit', async e => {
  e.preventDefault();

  const form = e.target;
  const propertyId = document.getElementById('uploadPropertyId').value;
  const formData = new FormData(form);

  

  let url = '';
  let method = '';

  if (MODAL_MODE === 'edit') {
    // EDITAR documento existente (PATCH)
    if (!EDIT_DOC_TYPE_ID) {
      alert('Selecciona el documento a editar');
      return;
    }
    const saveBtn = document.getElementById('saveBtn');

    saveBtn.disabled = true;
    saveBtn.innerHTML = `
      <span class="spinner-border spinner-border-sm me-2" role="status"></span>
      Guardando...
    `;


    url = `/dashboard/api/properties/${propertyId}/documents/by-type/${EDIT_DOC_TYPE_ID}/`;
    method = 'PATCH';

  } else {
    // CREAR documento nuevo (POST)
    const docTypeId = form.doc_type.value;

    if (!docTypeId) {
      alert('Por favor selecciona un tipo de documento.');
      return;
    }

    const saveBtn = document.getElementById('saveBtn');

      saveBtn.disabled = true;
      saveBtn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        Guardando...
      `;


    formData.set('document_type', docTypeId);
    url = `/dashboard/api/properties/${propertyId}/documents/`;
    method = 'POST';
  }

  try {
    const res = await fetch(url, {
      method,
      body: formData,
      headers: {
        'X-CSRFToken': getCSRFToken(),
      }
    });

    if (!res.ok) {
      const err = await res.text();
      console.error(err);
      throw new Error('Error subiendo documento');
    }

    const updatedProperty = await res.json();

    // cerrar modal
    bootstrap.Modal.getInstance(
      document.getElementById('uploadModal')
    ).hide();

    // actualizar solo la fila
    const index = window.__LEGAL_DATA__.findIndex(
      p => p.id === updatedProperty.id
    );

    if (index !== -1) {
      window.__LEGAL_DATA__[index] = updatedProperty;
      updatePropertyRow(updatedProperty);
    }

  } catch (err) {
    console.error(err);
    alert('No se pudo subir el documento');
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = 'Guardar';
  }
});



function renderPropertyDetails(p) {
  return `
    <div class="p-3 small bg-light rounded">
      <div class="d-md-flex gap-4">
        <div><strong>Creado:</strong> ${formatDate(p.created_at)}</div>
        <div><strong>Propietario:</strong> ${p.owner || '—'}</div>
        <div><strong>Subido por:</strong> ${p.created_by || '—'}</div>
      </div>

      <div class="d-flex gap-4">
        <a href="/dashboard/${p.id}/" 
          class="btn btn-primary btn-xs mt-3 mr-5">
          <i class="fas fa-eye"></i> Ver detalle
        </a>
        <div 
          class="btn btn-outline-primary btn-xs mt-3 edit-docs-btn"
          data-property="${p.id}">
          <i class="fas fa-edit"></i> Editar Documentos
        </div>

      </div>
    </div>
  `;
}

function formatDate(dateStr) {
  if (!dateStr) return '—';
  const d = new Date(dateStr);
  return isNaN(d) ? '—' : d.toLocaleDateString('es-PE');
}


document.addEventListener('click', e => {
  const btn = e.target.closest('.toggle-row');
  if (!btn) return;

  const id = btn.dataset.id;
  const row = document.getElementById(`details-${id}`);
  const icon = btn.querySelector('i');

  row.classList.toggle('d-none');
  icon.classList.toggle('fa-chevron-right');
  icon.classList.toggle('fa-chevron-down');
});

async function populateDocTypeSelect(propertyDocs, canUploadStudy) {
  const select = document.querySelector('#uploadForm select[name="doc_type"]');

  select.innerHTML = `<option value="">Selecciona</option>`;

  const allTypes = await getAllDocumentTypes();

  allTypes.forEach(type => {
    if (propertyDocs[type.name]) return;

    const option = document.createElement('option');
    option.value = type.id;
    option.textContent = type.name.replaceAll('_', ' ');

    if (
      type.name === 'Estudio_de_titulo' &&
      canUploadStudy === false
    ) {
      option.disabled = true;
      option.textContent += ' (no habilitado)';
    }

    select.appendChild(option);
  });


  if (select.options.length === 1) {
    select.innerHTML = `<option value="">No hay documentos pendientes</option>`;
    select.disabled = true;
  } else {
    select.disabled = false;
  }
}

function getCSRFToken() {
    return document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
}

const fileDrop = document.getElementById('fileDrop');
const fileInput = document.getElementById('fileInput');
const fileText = document.getElementById('fileText');

fileDrop.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', () => {
  if (!fileInput.files.length) return;

  const file = fileInput.files[0];

  fileText.innerHTML = `
    <i class="fas fa-check-circle text-success me-1"></i>
    ${file.name}
  `;

  fileDrop.classList.add('border-success');
});

function updatePropertyRow(p) {
  const tbody = document.getElementById('legalTableBody');

  const mainRow = document.getElementById(`property-row-${p.id}`);
  const detailsRow = document.getElementById(`details-${p.id}`);

  const docs = p.property_documents;
  const progress = calcProgress(docs);

  const newMainHTML = `
    <tr id="property-row-${p.id}">
      <td></td>
      <td>
        <div class="d-flex align-items-start gap-2">
          <button class="btn btn-sm btn-link p-0 toggle-row" data-id="${p.id}">
            <i class="fas fa-chevron-right"></i>
          </button>
          <div>
            <div class="fw-semibold text-wrap" style="max-width:248px">
              ${p.direccion}
            </div>
            <small class="text-muted">${p.code}</small>
          </div>
        </div>
      </td>

      <td class="text-center">${docIcon(docs.Titulo_dominio)}</td>
      <td class="text-center">${docIcon(docs.Partida_registral)}</td>
      <td class="text-center">${docIcon(docs.DNI_titular)}</td>
      <td class="text-center">${docIcon(docs.Estudio_de_titulo)}</td>
      <td class="text-center">${docIcon(docs.Contrato_de_corretaje)}</td>

      <td class="text-center">
        <div class="d-grid">${renderOtherDocs(docs)}</div>
      </td>

      <td class="text-end">
        <span class="badge rounded-pill bg-${
          progress === 100 ? 'success' :
          progress > 70 ? 'info' : 'warning'
        }">${progress}%</span>
      </td>

      <td class="text-center">
        <button class="btn btn-sm btn-outline-primary upload-btn"
                data-property="${p.id}">
          <i class="fas fa-upload"></i> <span>Subir</span>
        </button>
      </td>
    </tr>
  `;

  const newDetailsHTML = `
    <tr id="details-${p.id}" class="details-row">
      <td colspan="10" class="bg-light">
        ${renderPropertyDetails(p)}
      </td>
    </tr>
  `;

  mainRow.outerHTML = newMainHTML;
  detailsRow.outerHTML = newDetailsHTML;
}


document.addEventListener('click', async e => {
  const btn = e.target.closest('.edit-docs-btn');
  if (!btn) return;

  MODAL_MODE = 'edit';

  const propertyId = btn.dataset.property;
  const property = window.__LEGAL_DATA__.find(p => p.id == propertyId);

  document.getElementById('uploadPropertyId').value = propertyId;

  const form = document.getElementById('uploadForm');
  form.reset();

  document.getElementById('fileText').textContent =
    'Selecciona el archivo para reemplazar el documento';

  await populateEditDocTypeSelect(property.property_documents);

  const modal = new bootstrap.Modal(
    document.getElementById('uploadModal')
  );
  modal.show();
});

document
  .querySelector('#uploadForm select[name="doc_type"]')
  .addEventListener('change', e => {
    EDIT_DOC_TYPE_ID = e.target.value || null;
  });


async function populateEditDocTypeSelect(propertyDocs) {
  const select = document.querySelector(
    '#uploadForm select[name="doc_type"]'
  );

  select.innerHTML = `<option value="">Selecciona</option>`;

  const allTypes = await getAllDocumentTypes();

  allTypes.forEach(type => {
    if (!propertyDocs[type.name]) return;

    const option = document.createElement('option');
    option.value = type.id;
    option.textContent = type.name.replaceAll('_', ' ') + ' (reemplazar)';
    select.appendChild(option);
  });

  if (select.options.length === 1) {
    select.innerHTML = `<option>No hay documentos editables</option>`;
    select.disabled = true;
  } else {
    select.disabled = false;
  }
}


document
  .getElementById('uploadModal')
  .addEventListener('hidden.bs.modal', () => {
    MODAL_MODE = 'create';
    EDIT_DOC_TYPE_ID = null;
  });


</script>

{% endblock %}
