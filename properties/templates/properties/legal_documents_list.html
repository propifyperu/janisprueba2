{% extends 'properties/base_dashboard.html' %}

{% block dashboard_extra_css %}
<style>
    .legal-table th,
    .legal-table td {
        vertical-align: middle;
        white-space: nowrap;
    }

    .legal-table thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background: #f8f9fa;
    }

    .icon-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
    }

    .icon-btn i {
        font-size: 1.2rem;
    }

    .toggle-row i {
        transition: transform .2s ease;
    }

    tr[aria-expanded="true"] .toggle-row i {
        transform: rotate(180deg);
    }

    .doc-key {
        background: #e9f7ef; /* verde claro elegante */
    }

    .badge-doc {
        font-size: .7rem;
        margin: 0 .15rem .15rem 0;
    }
    .modal {
        z-index: 10000;
        height: 90%;
        top: 45px;

    }
</style>
{% endblock %}

{% block dashboard_content %}
<h3 class="mb-3">Área Legal — Documentos por Propiedad</h3>


<table class="table table-hover align-middle legal-table">
  <thead class="table-light sticky-top">
    <tr>
      <th></th>
      <th>Dirección</th>
      <th class="text-center">Título Dominio</th>
      <th class="text-center">Partida</th>
      <th class="text-center">DNI</th>
      <th class="text-center">Estudio Título</th>
      <th class="text-center">Corretaje</th>
      <th class="text-center">Otros</th>
      <th class="text-end">Avance</th>
      <th></th>
    </tr>
  </thead>

  <tbody id="legalTableBody">
    <tr>
      <td colspan="10" class="text-center text-muted py-4">
        Cargando documentos…
      </td>
    </tr>
  </tbody>
</table>
<div class="d-flex justify-content-between align-items-center mt-3">
  <button id="prevPage" class="btn btn-outline-secondary btn-sm" disabled>
    ← Anterior
  </button>

  <span id="pageInfo" class="text-muted small"></span>

  <button id="nextPage" class="btn btn-outline-secondary btn-sm" disabled>
    Siguiente →
  </button>
</div>


<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Vista previa del documento</h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="pdfFrame" src="" style="width:96%; height:80vh;" frameborder="0"></iframe>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" enctype="multipart/form-data">
      <div class="modal-header">
        <h6 class="modal-title">Subir documento</h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="property_id" id="uploadPropertyId">

        <div class="mb-3">
          <label class="form-label">Tipo de documento</label>
          <select name="doc_type" class="form-select" required>
            <option value="">Selecciona</option>
            <option value="estudio_del_titulo">Estudio del título</option>
            <option value="contrato_de_reserva">Contrato de reserva</option>
            <option value="contrato_de_corretaje">Contrato de corretaje</option>
            <option value="other">Otro</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Archivo (PDF)</label>
          <input type="file" name="file" class="form-control" accept="application/pdf" required>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
let currentPage = 1;
let nextPageUrl = null;
let prevPageUrl = null;

async function loadLegalDocuments(url = '/dashboard/api/properties/with-docs/') {
  const tbody = document.getElementById('legalTableBody');
  const pageInfo = document.getElementById('pageInfo');

  tbody.innerHTML = `
    <tr>
      <td colspan="10" class="text-center text-muted py-4">
        Cargando documentos…
      </td>
    </tr>
  `;

  try {
    const res = await fetch(url);
    const data = await res.json();

    nextPageUrl = data.next;
    prevPageUrl = data.previous;

    tbody.innerHTML = '';

    data.results.forEach(p => {
      const docs = p.property_documents;
      const progress = calcProgress(docs);

      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td></td>

          <td>
            <div class="fw-semibold text-wrap" style="max-width:248px">
              ${p.direccion}
            </div>
            <small class="text-muted">${p.code}</small>
          </td>

          <td class="text-center">${docIcon(docs.Titulo_dominio)}</td>
          <td class="text-center">${docIcon(docs.Partida_registral)}</td>
          <td class="text-center">${docIcon(docs.DNI_titular)}</td>
          <td class="text-center">${docIcon(docs.Estudio_de_titulo)}</td>
          <td class="text-center">${docIcon(docs.Contrato_de_corretaje)}</td>

          <td class="text-end">
            <span class="badge rounded-pill bg-${
              progress === 100 ? 'success' :
              progress > 70 ? 'info' : 'warning'
            }">${progress}%</span>
          </td>

          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary upload-btn"
                    data-property="${p.id}">
              <i class="fas fa-upload"></i>
            </button>
          </td>
        </tr>
      `);
    });

    document.getElementById('nextPage').disabled = !nextPageUrl;
    document.getElementById('prevPage').disabled = !prevPageUrl;

    pageInfo.textContent = `Página ${currentPage}`;

  } catch (e) {
    console.error(e);
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="text-danger text-center">
          Error cargando datos
        </td>
      </tr>
    `;
  }
}

/* helpers */

function docIcon(url) {
  if (!url) {
    return `<i class="fas fa-minus-circle text-muted opacity-50"></i>`;
  }

  // quitamos dominio y /media/
  const path = url.split('/media/')[1];

  return `
    <i class="fas fa-check-circle text-success cursor-pointer"
       data-preview-url="/media/${path}">
    </i>
  `;
}


function calcProgress(docs) {
  const total = Object.keys(docs).length;
  const present = Object.values(docs).filter(Boolean).length;
  return Math.round((present / total) * 100);
}

/* paginación */

document.getElementById('nextPage').addEventListener('click', () => {
  if (!nextPageUrl) return;
  currentPage++;
  loadLegalDocuments(nextPageUrl);
});

document.getElementById('prevPage').addEventListener('click', () => {
  if (!prevPageUrl) return;
  currentPage--;
  loadLegalDocuments(prevPageUrl);
});

/* preview PDF url lo */

document.addEventListener('click', function (e) {
  const el = e.target.closest('[data-preview-url]');
  if (!el) return;

  const url = el.dataset.previewUrl;
  console.log('Preview PDF:', url);

  const frame = document.getElementById('pdfFrame');
  if (!frame) {
    window.open(url, '_blank');
    return;
  }

  frame.src = url;

  const modalEl = document.getElementById('previewModal');
  if (modalEl) {
    new bootstrap.Modal(modalEl).show();
  } else {
    window.open(url, '_blank');
  }
});

/* init */

document.addEventListener('DOMContentLoaded', () => {
  loadLegalDocuments();
});
</script>

{% endblock %}
