{% extends 'properties/base_dashboard.html' %}
{% load static dict_extras %}

{% block title %}Mis Requerimientos - Propify{% endblock %}

{% block dashboard_extra_css %}
<style>
    .table thead th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: .04em;
        color: #6c757d;
        border-bottom: 1px solid #eef1f4;
        }

        .table tbody tr {
        transition: background-color .15s ease;
        }

        .table tbody tr:hover {
        background-color: #f8fafc;
        }

        .pagination .page-link {
        border-radius: 8px;
        }

</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-11">

      <!-- Header -->
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-4">
        <div>
          <h1 class="h4 fw-semibold mb-1">
            <i class="fas fa-clipboard-list me-2 text-teal"></i>Mis requerimientos
          </h1>
          <p class="text-muted small mb-0">
            Gestiona tus requerimientos y revisa las coincidencias disponibles
          </p>
        </div>

        <a href="{% url 'properties:requirements_create' %}" class="btn btn-teal px-4">
          <i class="fas fa-plus me-2"></i>Nuevo requerimiento
        </a>
      </div>

      <!-- Card -->
      <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-body p-0">

          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Teléfono</th>
                  <th>Tipo</th>
                  <th class="d-none d-lg-table-cell">Provincia</th>
                  <th class="d-none d-xl-table-cell">Distrito(s)</th>
                  <th>Presupuesto</th>
                  <th class="d-none d-md-table-cell">Área</th>
                  <th class="d-none d-md-table-cell">Fecha</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>

              <tbody>
                {% for r in requirements %}
                <tr>
                  <!-- Nombre -->
                  <td>
                    <div class="fw-medium">
                      {% if r.contact and r.contact.first_name %}
                        {{ r.contact.first_name }} {{ r.contact.last_name|default:"" }}
                      {% elif r.client_name %}
                        {{ r.client_name }}
                      {% else %}
                        -
                      {% endif %}
                    </div>
                  </td>

                  <!-- Teléfono -->
                  <td class="text-muted">
                    {% if r.contact and r.contact.phone %}
                      {{ r.contact.phone }}
                    {% elif r.phone %}
                      {{ r.phone }}
                    {% else %}
                      -
                    {% endif %}
                  </td>

                  <!-- Tipo -->
                  <td>
                    {% if r.property_type %}
                      <span class="badge bg-light text-dark border">
                        {{ r.property_type.name }}
                      </span>
                    {% else %}
                      -
                    {% endif %}
                  </td>

                  <!-- Provincia -->
                  <td class="d-none d-lg-table-cell">
                    {% if r.province %}
                      {{ r.province.name|default:r.province }}
                    {% else %}
                      -
                    {% endif %}
                  </td>

                  <!-- Distritos -->
                  <td class="d-none d-xl-table-cell">
                    {% with ds=r.districts.all %}
                      {% if ds and ds|length > 0 %}
                        {% for d in ds %}
                          {{ d.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      {% elif r.district %}
                        {{ r.district.name|default:r.district }}
                      {% else %}
                        -
                      {% endif %}
                    {% endwith %}
                  </td>

                  <!-- Presupuesto -->
                  <td>
                    {% with symbol=r.currency.symbol|default:"$" %}
                      <span class="fw-medium">
                        {% if r.budget_type == 'approx' %}
                          {{ symbol }} {{ r.budget_approx|default:"-" }}
                        {% else %}
                          {{ symbol }} {{ r.budget_min }} – {{ symbol }} {{ r.budget_max }}
                        {% endif %}
                      </span>
                    {% endwith %}
                  </td>

                  <!-- Área -->
                  <td class="d-none d-md-table-cell">
                    {% if r.area_type == 'approx' %}
                      {{ r.land_area_approx|default:"-" }} m²
                    {% else %}
                      {{ r.land_area_min }} – {{ r.land_area_max }} m²
                    {% endif %}
                  </td>

                  <!-- Fecha -->
                  <td class="d-none d-md-table-cell text-muted small">
                    {{ r.created_at|date:"d/m/Y" }}
                  </td>

                  <!-- Acciones -->
                  <td class="text-end text-nowrap">
                    {% if r.matches_count and r.matches_count > 0 %}
                      <span class="badge rounded-pill bg-teal text-dark mb-1">
                        {{ r.matches_count }} matches
                      </span>
                    {% endif %}

                    <div class="btn-group btn-group-sm">
                      <a href="{% url 'properties:requirements_detail' r.id %}"
                         class="btn btn-outline-secondary"
                         title="Ver">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'properties:requirements_edit' r.id %}"
                         class="btn btn-outline-secondary"
                         title="Editar">
                        <i class="fas fa-pen"></i>
                      </a>
                      <form method="post"
                            action="{% url 'properties:requirements_delete' r.id %}"
                            onsubmit="return confirm('¿Confirmas eliminar este requerimiento?');">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn btn-outline-danger"
                                title="Eliminar">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>

                {% empty %}
                <tr>
                  <td colspan="9" class="text-center py-5">
                    <i class="fas fa-folder-open fa-2x text-muted mb-3"></i>
                    <p class="fw-medium mb-1">Aún no has creado requerimientos</p>
                    <p class="text-muted small mb-3">
                      Crea uno para comenzar a recibir coincidencias
                    </p>
                    <a href="{% url 'properties:requirements_create' %}" class="btn btn-teal btn-sm">
                      Crear requerimiento
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Paginación -->
      {% if is_paginated %}
      <nav class="mt-4" aria-label="Paginación de requerimientos">
        <ul class="pagination pagination-sm justify-content-center">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
          </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
          <li class="page-item {% if page_obj.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
          </li>
          {% endfor %}

          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}
