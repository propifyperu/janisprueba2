{% extends 'properties/base_dashboard.html' %}
{% load static %}
{% load field_permissions %}

{% block title %}{{ property.title }} - Detalles{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-3 h-100 d-flex flex-column">
    
    <!-- Header de Acciones (Botones flotantes o superiores) -->
    <div class="d-flex justify-content-end mb-2">
        <div class="btn-group btn-group-sm">
            {% if user.is_superuser or property.created_by.id == user.id %}
            <a href="{% url 'properties:edit' property.pk %}" class="btn btn-outline-primary" title="Editar">
                <i class="fas fa-edit me-1"></i>Editar
            </a>
            {% endif %}
            <a href="{% url 'properties:timeline' property.pk %}" class="btn btn-outline-secondary" title="Historial">
                <i class="fas fa-history me-1"></i>Historial
            </a>
            <a href="{% url 'properties:list' %}" class="btn btn-outline-secondary" title="Volver">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <div class="row g-3 flex-grow-1">
        <!-- COLUMNA IZQUIERDA: Identidad Visual y Resumen (aprox 1/4) -->
        <div class="col-lg-3 col-md-4 d-flex flex-column gap-3">
            
            <!-- Bloque de Identidad -->
            <div class="bg-white p-3 rounded shadow-sm border">
                <!-- Título y Precio -->
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <h5 class="fw-bold text-dark mb-0 lh-sm" style="font-size: 1.1rem;">
                        {{ property.exact_address|default:property.title }}
                    </h5>
                    {% if field_permissions.price.can_view or not field_permissions.price %}
                    <span class="fw-bold text-primary fs-5 text-nowrap ms-2">
                        {{ property.currency.symbol }} {{ property.price|floatformat:0 }}
                    </span>
                    {% endif %}
                </div>
                <!-- Código Único -->
                <div class="text-muted small mb-2 fw-medium" style="color: #6c757d;">
                    {% if property.codigo_unico_propiedad %}
                    <i class="fas fa-hashtag me-1"></i>{{ property.codigo_unico_propiedad }}
                    {% else %}
                    <span class="fst-italic">Sin código</span>
                    {% endif %}
                </div>

                <!-- Carrusel Compacto -->
                <div class="position-relative bg-light rounded overflow-hidden mb-3 border" style="aspect-ratio: 4/3;">
                    {% if property.images.all %}
                        <div id="propertyCarousel" class="carousel slide w-100 h-100" data-bs-ride="false">
                            <div class="carousel-inner w-100 h-100">
                                {% for image in property.images.all %}
                                <div class="carousel-item w-100 h-100 {% if forloop.first %}active{% endif %}" onclick="openFullscreenModal('{% if image.image_blob %}{% url 'properties:image_blob' image.id %}{% else %}{{ image.image.url }}{% endif %}', '{{ image.caption|escapejs }}')">
                                    {% if image.image_blob %}
                                        <img src="{% url 'properties:image_blob' image.id %}" class="d-block w-100 h-100" style="object-fit: cover; cursor: zoom-in;" alt="{{ image.caption }}">
                                    {% elif image.image %}
                                        <img src="{{ image.image.url }}" class="d-block w-100 h-100" style="object-fit: cover; cursor: zoom-in;" alt="{{ image.caption }}">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% if property.images.count > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev" style="width: 15%;">
                                <span class="carousel-control-prev-icon bg-dark bg-opacity-50 rounded-1" style="width: 1.5rem; height: 1.5rem;" aria-hidden="true"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next" style="width: 15%;">
                                <span class="carousel-control-next-icon bg-dark bg-opacity-50 rounded-1" style="width: 1.5rem; height: 1.5rem;" aria-hidden="true"></span>
                            </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center w-100 h-100 text-muted">
                            <i class="fas fa-image fa-2x"></i>
                        </div>
                    {% endif %}
                </div>

                <!-- Características Compactas -->
                <div class="row g-2 text-center small text-secondary">
                    <div class="col-4">
                        <div class="p-1 border rounded bg-light" title="Dormitorios">
                            <i class="fas fa-bed mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.bedrooms }}</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-1 border rounded bg-light" title="Baños">
                            <i class="fas fa-bath mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.bathrooms }}</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-1 border rounded bg-light" title="Cocheras">
                            <i class="fas fa-car mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.garage_spaces }}</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-1 border rounded bg-light" title="Área Total">
                            <i class="fas fa-ruler-combined mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.land_area|floatformat:0 }}</span> {{ property.land_area_unit.symbol }}
                        </div>
                    </div>
                    {% if property.built_area %}
                    <div class="col-6">
                         <div class="p-1 border rounded bg-light" title="Área Techada">
                            <i class="fas fa-home mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.built_area|floatformat:0 }}</span> {{ property.built_area_unit.symbol }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
        </div>

        <!-- COLUMNA CENTRAL + DERECHA (El resto de la info) -->
        <div class="col-lg-9 col-md-8">
            <div class="row g-3 h-100">
                
                <!-- DATOS DE CONTACTO (Al costado de la galería) -->
                <div class="col-md-6 order-md-1">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-bottom-0 fw-bold text-uppercase small text-muted py-2">
                            <i class="fas fa-address-card me-2"></i>Contacto & Propietario
                        </div>
                        <div class="card-body py-2">
                            <!-- Datos del Propietario -->
                            {% if property.owner %}
                            <div class="d-flex align-items-center mb-3 p-2 border rounded bg-light bg-opacity-50">
                                <div class="avatar-circle bg-primary text-white me-3 d-flex align-items-center justify-content-center rounded-circle" style="width: 40px; height: 40px;">
                                    {{ property.owner.first_name|first|upper }}
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h6 class="mb-0 text-truncate fw-bold">{{ property.owner.first_name }} {{ property.owner.last_name }}</h6>
                                    <small class="text-muted d-block text-truncate">
                                        {{ property.owner.document_number|default:"Sin documento" }}
                                    </small>
                                </div>
                                <a href="#" class="btn btn-sm btn-outline-primary rounded-circle"><i class="fas fa-phone"></i></a>
                            </div>
                            {% else %}
                            <div class="alert alert-warning py-1 px-2 small mb-3">Sin propietario asignado</div>
                            {% endif %}

                            <!-- Datos del Agente (Usuario creador o asignado) -->
                            <div class="small">
                                <strong class="text-muted">Captador:</strong> 
                                {{ property.created_by.get_full_name|default:property.created_by.username }}
                            </div>
                            <!-- Estado de negociación -->
                            <div class="mt-2">
                                <span class="badge bg-info text-dark border"><i class="fas fa-handshake me-1"></i>{{ property.negotiation_status.name|default:"En cartera" }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INFO LEGAL Y DETALLES (Costado o Abajo según espacio) -->
                <div class="col-md-6 order-md-2">
                    <div class="card shadow-sm border-0 h-100" style="max-height: 400px; overflow-y: auto;">
                        <div class="card-header bg-white p-0 border-bottom">
                            <ul class="nav nav-tabs card-header-tabs m-0" id="propertyTabs" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active small py-2 border-top-0 border-start-0" data-bs-toggle="tab" data-bs-target="#legal" type="button">Legal</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link small py-2 border-top-0" data-bs-toggle="tab" data-bs-target="#ubicacion" type="button">Ubicación</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link small py-2 border-top-0" data-bs-toggle="tab" data-bs-target="#descr" type="button">Info</button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body p-2 pt-3">
                            <div class="tab-content">
                                <!-- TAB LEGAL -->
                                <div class="tab-pane fade show active" id="legal">
                                    <table class="table table-sm table-borderless small mb-0">
                                        <tr>
                                            <td class="text-muted w-25">Partida Elec:</td>
                                            <td class="fw-bold font-monospace">{{ property.electronic_entry|default:"-" }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Contrato:</td>
                                            <td>{{ property.contract_type|default:"-"|title }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Comisión:</td>
                                            <td>{{ property.commission_percentage|default:"0" }}%</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Zonificación:</td>
                                            <td>{{ property.zoning_code|default:"-" }}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Cargas:</td>
                                            <td>
                                                {% if property.has_loads %}<span class="badge bg-danger">SÍ</span>{% else %}<span class="badge bg-secondary">NO</span>{% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <!-- TAB UBICACIÓN -->
                                <div class="tab-pane fade" id="ubicacion">
                                    <p class="small mb-2"><strong>Dirección:</strong> {{ property.address }}</p>
                                    <p class="small mb-2"><strong>Referencia:</strong> {{ property.reference|default:"Sin referencia" }}</p>
                                    <p class="small mb-0"><strong>Distrito:</strong> {{ property.district }} - {{ property.province }}</p>
                                    {% if property.google_maps_url %}
                                    <a href="{{ property.google_maps_url }}" target="_blank" class="btn btn-sm btn-outline-success mt-2 w-100">
                                        <i class="fas fa-map-marked-alt me-1"></i>Ver en Maps
                                    </a>
                                    {% endif %}
                                </div>

                                <!-- TAB INFO GENERAL -->
                                <div class="tab-pane fade" id="descr">
                                    <div class="small">
                                        <strong>Descripción:</strong><br>
                                        <p class="text-muted mb-0" style="white-space: pre-line;">{{ property.description|default:"Sin descripción"|truncatechars:200 }}</p>
                                    </div>
                                    <div class="mt-2 pt-2 border-top small">
                                        <span class="badge bg-light text-dark border">Antigüedad: {{ property.age_years|default:"0" }} años</span>
                                        <span class="badge bg-light text-dark border">Piso: {{ property.floor_number|default:"-" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN DOCUMENTOS (Fila completa abajo) -->
                <div class="col-12 order-md-3">
                     <div class="card shadow-sm border-0">
                        <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                            <span class="small fw-bold text-uppercase"><i class="fas fa-folder-open me-2"></i>Matriz Documental</span>
                            <span class="badge bg-primary rounded-pill">{{ property.uploaded_documents.count }}</span>
                        </div>
                        <div class="card-body p-2">
                             {% include 'properties/legal_documents_list.html' with simple_view=True %}
                        </div>
                     </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Modal Fullscreen para Imágenes -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true" style="z-index: 10000;">
    <div class="modal-dialog modal-fullscreen bg-black">
        <div class="modal-content bg-black">
            <div class="modal-header border-0 bg-black text-white p-2">
                <h5 class="modal-title fs-6" id="modalImageCaption"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex align-items-center justify-content-center bg-black position-relative">
                <img src="" id="modalImage" class="img-fluid" style="max-height: 90vh; max-width: 100vw; object-fit: contain;">
                
                <!-- Navegación en modal -->
                <button class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-3 rounded-circle bg-opacity-50 border-0" onclick="prevModalImage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-3 rounded-circle bg-opacity-50 border-0" onclick="nextModalImage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const imagesList = [
        {% for image in property.images.all %}
        {
            src: "{% if image.image_blob %}{% url 'properties:image_blob' image.id %}{% else %}{{ image.image.url }}{% endif %}",
            caption: "{{ image.caption|escapejs }}"
        },
        {% endfor %}
    ];
    let currentImageIndex = 0;
    const modalInstance = new bootstrap.Modal(document.getElementById('imageModal'));

    function openFullscreenModal(src, caption) {
        // Encontrar índice
        currentImageIndex = imagesList.findIndex(img => img.src === src);
        updateModalContent();
        modalInstance.show();
    }

    function updateModalContent() {
        if(currentImageIndex < 0) return;
        const img = imagesList[currentImageIndex];
        document.getElementById('modalImage').src = img.src;
        document.getElementById('modalImageCaption').textContent = img.caption || 'Imagen ' + (currentImageIndex + 1);
    }

    function nextModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex + 1) % imagesList.length;
        updateModalContent();
    }

    function prevModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex - 1 + imagesList.length) % imagesList.length;
        updateModalContent();
    }

    // Teclado
    document.addEventListener('keydown', function(event) {
        if (!document.getElementById('imageModal').classList.contains('show')) return;
        if (event.key === 'ArrowLeft') prevModalImage();
        if (event.key === 'ArrowRight') nextModalImage();
    });
</script>
<style>
    /* Ajustes compactos */
    .table td, .table th {
        padding: 0.25rem 0;
        vertical-align: middle;
    }
    .nav-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 2px solid #0d6efd;
    }
    .fs-7 { font-size: 0.85rem; }
    
    /* Scrollbar fino para cards */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    ::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }
</style>
{% endblock %}
