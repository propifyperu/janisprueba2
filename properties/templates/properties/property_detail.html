{% extends 'properties/base_dashboard.html' %}
{% load static %}
{% load field_permissions %}

{% block title %}{{ property.title }} - Detalles{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-2 h-100 d-flex flex-column">
    {% if user.is_superuser or property.created_by.id == user.id %}
        {% with is_owner_or_admin=True %}
            {% include "properties/property_detail_body.html" %}
        {% endwith %}
    {% else %}
        {% with is_owner_or_admin=False %}
            {% include "properties/property_detail_body.html" %}
        {% endwith %}
    {% endif %}
</div>

<!-- Modal Fullscreen -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true" style="z-index: 10000;">
    <div class="modal-dialog modal-fullscreen bg-black">
        <div class="modal-content bg-black">
            <div class="modal-header border-0 bg-black text-white p-2">
                <h5 class="modal-title fs-6" id="modalImageCaption"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex align-items-center justify-content-center bg-black position-relative">
                <img src="" id="modalImage" class="img-fluid" style="max-height: 90vh; max-width: 100vw; object-fit: contain;">
                <button class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-3 rounded-circle bg-opacity-50 border-0" onclick="prevModalImage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-3 rounded-circle bg-opacity-50 border-0" onclick="nextModalImage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_extra_js %}
<script>
    const imagesList = [
        {% for image in property.images.all %}
        {
            src: "{{ image.image.url }}",
            caption: "{{ image.caption|escapejs }}"
        },
        {% endfor %}
    ];
    let currentImageIndex = 0;
    
    // Inicializar el modal de Bootstrap cuando el DOM estÃ© listo
    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('imageModal');
        if (modalElement) {
            window.propertyModalInstance = new bootstrap.Modal(modalElement);
        }
    });

    function openFullscreenModal(src, caption) {
        currentImageIndex = imagesList.findIndex(img => img.src === src);
        updateModalContent();
        if (window.propertyModalInstance) {
            window.propertyModalInstance.show();
        }
    }

    function updateModalContent() {
        if(currentImageIndex < 0) return;
        const img = imagesList[currentImageIndex];
        const modalImg = document.getElementById('modalImage');
        const modalCaption = document.getElementById('modalImageCaption');
        if (modalImg) modalImg.src = img.src;
        if (modalCaption) modalCaption.textContent = img.caption || 'Imagen ' + (currentImageIndex + 1);
    }

    function nextModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex + 1) % imagesList.length;
        updateModalContent();
    }

    function prevModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex - 1 + imagesList.length) % imagesList.length;
        updateModalContent();
    }

    document.addEventListener('keydown', function(event) {
        const modalElement = document.getElementById('imageModal');
        if (!modalElement || !modalElement.classList.contains('show')) return;
        if (event.key === 'ArrowLeft') prevModalImage();
        if (event.key === 'ArrowRight') nextModalImage();
    });
</script>
{% endblock %}
