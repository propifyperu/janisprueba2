{% extends 'properties/base_dashboard.html' %}
{% load static %}
{% load field_permissions %}

{% block title %}{{ property.title }} - Detalles{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-3 h-100 d-flex flex-column">
    
    <!-- Header de Acciones -->
    <div class="d-flex justify-content-end mb-2">
        <div class="btn-group btn-group-sm">
            {% if user.is_superuser or property.created_by.id == user.id %}
            <a href="{% url 'properties:edit' property.pk %}" class="btn btn-outline-primary" title="Editar">
                <i class="fas fa-edit me-1"></i>Editar
            </a>
            {% endif %}
            <a href="{% url 'properties:timeline' property.pk %}" class="btn btn-outline-secondary" title="Historial">
                <i class="fas fa-history me-1"></i>Historial
            </a>
            <a href="{% url 'properties:list' %}" class="btn btn-outline-secondary" title="Volver">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <div class="row g-3 flex-grow-1">
        <!-- COLUMNA IZQUIERDA: Galería y Resumen Clave -->
        <div class="col-lg-3 col-md-4 d-flex flex-column gap-3">
            
            <div class="bg-white p-3 rounded shadow-sm border">
                <!-- Título y Precio -->
                <div class="mb-2">
                    <h5 class="fw-bold text-dark mb-1 lh-sm" style="font-size: 1.1rem;">
                        {{ property.exact_address|default:property.title }}
                    </h5>
                    {% if field_permissions.price.can_view or not field_permissions.price %}
                    <div class="fw-bold text-primary fs-5">
                        {{ property.currency.symbol }} {{ property.price|floatformat:0 }}
                    </div>
                    {% endif %}
                    {% if property.codigo_unico_propiedad %}
                    <div class="text-muted small mt-1"><i class="fas fa-hashtag me-1"></i>{{ property.codigo_unico_propiedad }}</div>
                    {% endif %}
                </div>

                <!-- Carrusel de Fotos (Galería) -->
                <div class="position-relative bg-light rounded overflow-hidden mb-3 border" style="aspect-ratio: 4/3;">
                    {% if property.images.all %}
                        <div id="propertyCarousel" class="carousel slide w-100 h-100" data-bs-ride="false">
                            <div class="carousel-inner w-100 h-100">
                                {% for image in property.images.all %}
                                <div class="carousel-item w-100 h-100 {% if forloop.first %}active{% endif %}" onclick="openFullscreenModal('{% if image.image_blob %}{% url 'properties:image_blob' image.id %}{% else %}{{ image.image.url }}{% endif %}', '{{ image.caption|escapejs }}')">
                                    {% if image.image_blob %}
                                        <img src="{% url 'properties:image_blob' image.id %}" class="d-block w-100 h-100" style="object-fit: cover; cursor: zoom-in;" alt="{{ image.caption }}">
                                    {% elif image.image %}
                                        <img src="{{ image.image.url }}" class="d-block w-100 h-100" style="object-fit: cover; cursor: zoom-in;" alt="{{ image.caption }}">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% if property.images.count > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev" style="width: 15%;">
                                <span class="carousel-control-prev-icon bg-dark bg-opacity-50 rounded-1" style="width: 1.5rem; height: 1.5rem;" aria-hidden="true"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next" style="width: 15%;">
                                <span class="carousel-control-next-icon bg-dark bg-opacity-50 rounded-1" style="width: 1.5rem; height: 1.5rem;" aria-hidden="true"></span>
                            </button>
                            {% endif %}
                            <!-- Indicador de cantidad -->
                            <div class="position-absolute bottom-0 end-0 m-2 badge bg-dark bg-opacity-75">
                                <i class="fas fa-images me-1"></i>{{ property.images.count }}
                            </div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center w-100 h-100 text-muted">
                            <i class="fas fa-image fa-2x"></i>
                        </div>
                    {% endif %}
                </div>

                <!-- Resumen Rápido -->
                <div class="row g-2 text-center small text-secondary">
                    <div class="col-4">
                        <div class="p-1 border rounded bg-light" title="Dormitorios">
                            <i class="fas fa-bed mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.bedrooms }}</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-1 border rounded bg-light" title="Baños">
                            <i class="fas fa-bath mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.bathrooms }}</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-1 border rounded bg-light" title="Cocheras">
                            <i class="fas fa-car mb-1 d-block text-primary"></i>
                            <span class="fw-bold text-dark">{{ property.garage_spaces }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Box Responsable / Contacto -->
             <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom-0 fw-bold text-uppercase small text-muted py-2">
                    <i class="fas fa-address-card me-2"></i>Contacto
                </div>
                <div class="card-body py-2 small">
                    <div class="mb-2">
                        <strong class="text-dark d-block">Propietario:</strong>
                        {% if property.owner %}
                            <span class="text-muted">{{ property.owner.first_name }} {{ property.owner.last_name }}</span>
                        {% else %}
                            <span class="text-warning">Sin asignar</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong class="text-dark d-block">Captador:</strong>
                        <span class="text-muted">{{ property.created_by.get_full_name|default:property.created_by.username }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLUMNA CENTRAL: Pestañas con la Info Organizada -->
        <div class="col-lg-9 col-md-8">
            <div class="card shadow-sm border-0 h-100" style="overflow-y: auto;">
                <div class="card-header bg-white p-0 border-bottom">
                    <ul class="nav nav-tabs card-header-tabs m-0" id="propertyTabs" role="tablist">
                        <!-- Pestañas igualando grupos de Create -->
                        <li class="nav-item">
                            <button class="nav-link active small py-2 border-top-0 border-start-0" data-bs-toggle="tab" data-bs-target="#basica" type="button">Info Básica</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small py-2 border-top-0" data-bs-toggle="tab" data-bs-target="#finanzas" type="button">Negociación y Finanzas</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small py-2 border-top-0" data-bs-toggle="tab" data-bs-target="#caracteristicas" type="button">Características</button>
                        </li>
                         <li class="nav-item">
                            <button class="nav-link small py-2 border-top-0" data-bs-toggle="tab" data-bs-target="#ubicacion" type="button">Ubicación</button>
                        </li>
                         <li class="nav-item">
                            <button class="nav-link small py-2 border-top-0" data-bs-toggle="tab" data-bs-target="#servicios" type="button">Servicios</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link small py-2 border-top-0" data-bs-toggle="tab" data-bs-target="#publicidad" type="button">Publicidad</button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body p-3">
                    <div class="tab-content">
                        
                        <!-- 1. INFORMACIÓN BÁSICA -->
                        <div class="tab-pane fade show active" id="basica">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Tipo:</label>
                                    <div class="small">{{ property.property_type.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Subtipo:</label>
                                    <div class="small">{{ property.property_subtype.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Estado:</label>
                                    <span class="badge bg-light text-dark border">{{ property.status.name|default:"-" }}</span>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Condición:</label>
                                    <div class="small">{{ property.condition.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Forma de Pago:</label>
                                    <div class="small">{{ property.forma_de_pago.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-4">
                                     <label class="small text-muted fw-bold">Mantenimiento:</label>
                                     <div class="small">{% if property.has_maintenance %}Sí{% else %}No{% endif %}</div>
                                </div>
                                {% if property.is_project %}
                                <div class="col-12 mt-2">
                                    <div class="alert alert-info py-2 px-3 small mb-0">
                                        <i class="fas fa-building me-1"></i> Es Proyecto: <strong>{{ property.project_name|default:"Sin nombre" }}</strong>
                                    </div>
                                </div>
                                {% endif %}
                                {% if property.antiquity_years %}
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Antigüedad:</label>
                                    <div class="small">{{ property.antiquity_years }} años</div>
                                </div>
                                {% endif %}
                                {% if property.delivery_date %}
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Entrega estimada:</label>
                                    <div class="small">{{ property.delivery_date|date:"d/m/Y" }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 2. NEGOCIACIÓN Y FINANZAS -->
                        <div class="tab-pane fade" id="finanzas">
                             <div class="row g-3">
                                <div class="col-md-6 col-lg-4">
                                    <div class="p-2 border rounded bg-light bg-opacity-50 h-100">
                                        <label class="small text-muted fw-bold d-block">Comisión Inicial</label>
                                        <span class="fs-6 fw-bold text-success">{{ property.initial_commission_percentage|default:"0" }}%</span>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="p-2 border rounded bg-light bg-opacity-50 h-100">
                                        <label class="small text-muted fw-bold d-block">Comisión Final</label>
                                        <span class="fs-6 fw-bold text-success">{{ property.final_commission_percentage|default:"0" }}%</span>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-4">
                                    <div class="p-2 border rounded bg-light bg-opacity-50 h-100">
                                        <label class="small text-muted fw-bold d-block">Monto Final Negociado</label>
                                        <span class="fs-6 fw-bold text-dark">{{ property.currency.symbol|default:"$" }} {{ property.final_amount|floatformat:2|default:"0.00" }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                     <label class="small text-muted fw-bold">Estado Negociación:</label>
                                     <div class="small"><span class="badge bg-warning text-dark">{{ property.negotiation_status.name|default:"-" }}</span></div>
                                </div>
                                <div class="col-md-6">
                                     <label class="small text-muted fw-bold">Tipo de Contrato:</label>
                                     <div class="small fw-bold">{{ property.contract_type.name|default:"-" }}</div>
                                </div>
                            </div>
                        </div>

                         <!-- 3. CARACTERÍSTICAS -->
                         <div class="tab-pane fade" id="caracteristicas">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Área Terreno:</label>
                                    <div class="small">{{ property.land_area|floatformat:0 }} {{ property.land_area_unit.symbol }}</div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Área Construida:</label>
                                    <div class="small">{{ property.built_area|floatformat:0 }} {{ property.built_area_unit.symbol }}</div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Frentera:</label>
                                    <div class="small">{{ property.front_measure|default:"-" }}</div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Fondo:</label>
                                    <div class="small">{{ property.depth_measure|default:"-" }}</div>
                                </div>
                                <div class="col-12 border-top my-2"></div>
                                <div class="col-6 col-md-2">
                                    <label class="small text-muted fw-bold">Dormitorios:</label>
                                    <div class="small">{{ property.bedrooms }}</div>
                                </div>
                                <div class="col-6 col-md-2">
                                    <label class="small text-muted fw-bold">Baños:</label>
                                    <div class="small">{{ property.bathrooms }}</div>
                                </div>
                                <div class="col-6 col-md-2">
                                    <label class="small text-muted fw-bold">½ Baños:</label>
                                    <div class="small">{{ property.half_bathrooms }}</div>
                                </div>
                                <div class="col-6 col-md-2">
                                    <label class="small text-muted fw-bold">Pisos:</label>
                                    <div class="small">{{ property.floors }}</div>
                                </div>
                                <div class="col-6 col-md-2">
                                    <label class="small text-muted fw-bold">Estacionamientos:</label>
                                    <div class="small">{{ property.garage_spaces }}</div>
                                </div>
                                <div class="col-6 col-md-2">
                                    <label class="small text-muted fw-bold">Tipo Garaje:</label>
                                    <div class="small">{{ property.garage_type.name|default:"-" }}</div>
                                </div>
                                {% if property.parking_cost > 0 %}
                                <div class="col-12">
                                    <div class="small text-muted">Coste Cochera: <strong>{{ property.parking_cost }}</strong> (Incluido: {{ property.parking_cost_included|yesno:"Sí,No" }})</div>
                                </div>
                                {% endif %}
                                {% if property.zoning %}
                                <div class="col-12 mt-2">
                                    <label class="small text-muted fw-bold">Zonificación:</label>
                                    <div class="small">{{ property.zoning }}</div>
                                </div>
                                {% endif %}
                            </div>
                         </div>

                         <!-- 4. UBICACIÓN -->
                         <div class="tab-pane fade" id="ubicacion">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="small text-muted fw-bold">Dirección Real:</label>
                                    <div class="small">{{ property.real_address|default:"-" }}</div>
                                </div>
                                <div class="col-12">
                                    <label class="small text-muted fw-bold">Dirección Mapa:</label>
                                    <div class="small">{{ property.exact_address|default:"-" }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Departamento:</label>
                                    <div class="small">{{ property.department.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Provincia:</label>
                                    <div class="small">{{ property.province.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="small text-muted fw-bold">Distrito:</label>
                                    <div class="small">{{ property.district.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Urbanización:</label>
                                    <div class="small">{{ property.urbanization.name|default:"-" }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Coordenadas:</label>
                                    <div class="small text-monospace bg-light rounded px-2 py-1">{{ property.coordinates|default:"-" }}</div>
                                </div>
                                {% if property.google_maps_url %}
                                <div class="col-12 mt-2">
                                    <a href="{{ property.google_maps_url }}" target="_blank" class="btn btn-sm btn-outline-success w-100">
                                        <i class="fas fa-map-marked-alt me-1"></i>Ver en Google Maps
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                         </div>

                         <!-- 5. SERVICIOS -->
                         <div class="tab-pane fade" id="servicios">
                            <div class="row g-3">
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Agua:</label>
                                    <div class="small">{{ property.water_service.name|default:"-" }}</div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Luz:</label>
                                    <div class="small">{{ property.energy_service.name|default:"-" }}</div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Desagüe:</label>
                                    <div class="small">{{ property.drainage_service.name|default:"-" }}</div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label class="small text-muted fw-bold">Gas:</label>
                                    <div class="small">{{ property.gas_service.name|default:"-" }}</div>
                                </div>
                            </div>
                         </div>

                         <!-- 6. PUBLICIDAD -->
                         <div class="tab-pane fade" id="publicidad">
                            <div class="mb-3">
                                <label class="small text-muted fw-bold">Título del Anuncio:</label>
                                <div class="small fw-bold">{{ property.title }}</div>
                            </div>
                            <div>
                                <label class="small text-muted fw-bold">Descripción:</label>
                                <div class="small text-secondary" style="white-space: pre-line; max-height: 250px; overflow-y: auto;">
                                    {{ property.description|default:"Sin descripción" }}
                                </div>
                            </div>
                         </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Fullscreen para Imágenes -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true" style="z-index: 10000;">
    <div class="modal-dialog modal-fullscreen bg-black">
        <div class="modal-content bg-black">
            <div class="modal-header border-0 bg-black text-white p-2">
                <h5 class="modal-title fs-6" id="modalImageCaption"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex align-items-center justify-content-center bg-black position-relative">
                <img src="" id="modalImage" class="img-fluid" style="max-height: 90vh; max-width: 100vw; object-fit: contain;">
                
                <button class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-3 rounded-circle bg-opacity-50 border-0" onclick="prevModalImage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-3 rounded-circle bg-opacity-50 border-0" onclick="nextModalImage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const imagesList = [
        {% for image in property.images.all %}
        {
            src: "{% if image.image_blob %}{% url 'properties:image_blob' image.id %}{% else %}{{ image.image.url }}{% endif %}",
            caption: "{{ image.caption|escapejs }}"
        },
        {% endfor %}
    ];
    let currentImageIndex = 0;
    const modalInstance = new bootstrap.Modal(document.getElementById('imageModal'));

    function openFullscreenModal(src, caption) {
        currentImageIndex = imagesList.findIndex(img => img.src === src);
        updateModalContent();
        modalInstance.show();
    }

    function updateModalContent() {
        if(currentImageIndex < 0) return;
        const img = imagesList[currentImageIndex];
        document.getElementById('modalImage').src = img.src;
        document.getElementById('modalImageCaption').textContent = img.caption || 'Imagen ' + (currentImageIndex + 1);
    }

    function nextModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex + 1) % imagesList.length;
        updateModalContent();
    }

    function prevModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex - 1 + imagesList.length) % imagesList.length;
        updateModalContent();
    }

    document.addEventListener('keydown', function(event) {
        if (!document.getElementById('imageModal').classList.contains('show')) return;
        if (event.key === 'ArrowLeft') prevModalImage();
        if (event.key === 'ArrowRight') nextModalImage();
    });
</script>
<style>
    .nav-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        border-radius: 0;
    }
    .nav-tabs .nav-link.active {
        color: #047d7d;
        border-bottom: 2px solid #047d7d;
        background-color: #fff;
    }
    .fs-7 { font-size: 0.85rem; }
</style>
{% endblock %}
