{% extends 'properties/base_dashboard.html' %}
{% load static %}
{% load field_permissions %}

{% block title %}{{ property.title }} - Detalles{% endblock %}

{% block dashboard_content %}
<div class="container-fluid p-0" style="height: calc(100vh - 60px); overflow: hidden;">
    <div class="row g-0 h-100">
        <!-- Columna Izquierda: Galería (60-65% ancho) -->
        <div class="col-lg-7 d-flex flex-column h-100 bg-black">
            <!-- Área Principal de Imagen -->
            <div class="flex-grow-1 position-relative" style="min-height: 0;">
                {% if property.images.all %}
                    <div id="propertyCarousel" class="carousel slide h-100" data-bs-interval="false">
                        <div class="carousel-inner h-100">
                            {% for image in property.images.all %}
                            <div class="carousel-item h-100 {% if forloop.first %}active{% endif %}">
                                <div class="d-flex align-items-center justify-content-center w-100 h-100 bg-black">
                                    {% if image.image_blob %}
                                        <img src="{% url 'properties:image_blob' image.id %}" class="mw-100 mh-100" style="object-fit: contain; cursor: zoom-in;" 
                                             alt="{{ image.caption }}"
                                             onclick="openFullscreenModal(this.src, '{{ image.caption|escapejs }}')">
                                    {% elif image.image %}
                                        <img src="{{ image.image.url }}" class="mw-100 mh-100" style="object-fit: contain; cursor: zoom-in;" 
                                             alt="{{ image.caption }}"
                                             onclick="openFullscreenModal(this.src, '{{ image.caption|escapejs }}')">
                                    {% endif %}
                                </div>
                                {% if image.caption %}
                                <div class="carousel-caption d-none d-md-block py-1 bg-dark bg-opacity-75 w-100 start-0 bottom-0 position-absolute text-start px-3 mb-0">
                                    <small class="mb-0 text-white">{{ image.caption }}</small>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if property.images.count > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev" style="width: 5%;">
                            <span class="carousel-control-prev-icon" aria-hidden="true" style="filter: drop-shadow(0px 0px 2px rgba(0,0,0,0.8));"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next" style="width: 5%;">
                            <span class="carousel-control-next-icon" aria-hidden="true" style="filter: drop-shadow(0px 0px 2px rgba(0,0,0,0.8));"></span>
                        </button>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100 bg-secondary text-white">
                        <div class="text-center">
                            <i class="fas fa-camera fa-2x mb-2"></i>
                            <p>Sin imágenes</p>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Tira de Miniaturas (Compacta) -->
            {% if property.images.count > 1 %}
            <div class="d-flex overflow-auto bg-dark p-1 gap-1" style="height: 70px; flex-shrink: 0;">
                {% for image in property.images.all %}
                <div id="thumb-{{ forloop.counter0 }}" class="thumb-item flex-shrink-0 border border-secondary" 
                     style="width: 80px; height: 100%; cursor: pointer; opacity: 0.6; transition: opacity 0.2s;"
                     onclick="goToSlide({{ forloop.counter0 }})">
                    {% if image.image_blob %}
                        <img src="{% url 'properties:image_blob' image.pk %}" class="w-100 h-100" style="object-fit: cover;" alt="thumb">
                    {% elif image.image %}
                        <img src="{{ image.image.url }}" class="w-100 h-100" style="object-fit: cover;" alt="thumb">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Columna Derecha: Información (35-40% ancho, Scrollable) -->
        <div class="col-lg-5 h-100 overflow-auto bg-white border-start">
            <div class="p-4">
                <!-- Header y Acciones -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h1 class="h4 fw-bold mb-1 text-dark">{{ property.exact_address|default:property.title }}</h1>
                        <div class="text-muted small d-flex align-items-center gap-2">
                            {% if property.codigo_unico_propiedad %}
                            <span><i class="fas fa-hashtag me-1"></i>{{ property.codigo_unico_propiedad }}</span>
                            {% endif %}
                            <span class="badge {% if property.is_active %}bg-success{% else %}bg-secondary{% endif %} rounded-pill">
                                {{ property.status.name|default:"Activo" }}
                            </span>
                        </div>
                    </div>
                    <!-- Botones compactos -->
                    <div class="btn-group btn-group-sm">
                        {% if user.is_superuser or property.created_by.id == user.id %}
                        <a href="{% url 'properties:edit' property.pk %}" class="btn btn-outline-secondary btn-sm" title="Editar"><i class="fas fa-edit"></i></a>
                        {% endif %}
                        <a href="{% url 'properties:timeline' property.pk %}" class="btn btn-outline-secondary btn-sm" title="Historial"><i class="fas fa-history"></i></a>
                        <a href="{% url 'properties:list' %}" class="btn btn-outline-secondary btn-sm" title="Volver"><i class="fas fa-arrow-left"></i></a>
                    </div>
                </div>

                <!-- Bloque Precio y Ubicación -->
                <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-3">
                    <div>
                         {% if field_permissions.price.can_view or not field_permissions.price %}
                        <h2 class="display-6 fw-bold text-black mb-0">
                            {{ property.currency.symbol }} {{ property.price|floatformat:0 }}
                        </h2>
                        {% endif %}
                        <div class="text-muted small">{{ property.get_unit_location_display }}</div>
                    </div>
                    <div class="text-end text-muted small">
                        {% if property.maintenance_fee %}
                        <div>Mant: {{ property.currency.symbol }}{{ property.maintenance_fee|floatformat:0 }}</div>
                        {% endif %}
                        {% if property.land_area %}
                        <div>{{ property.land_area|floatformat:0 }} {{ property.land_area_unit.symbol }} Total</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Características Principales (Compacto Grid) -->
                <div class="row row-cols-3 g-2 mb-3">
                    <div class="col text-center border-end">
                        <div class="d-flex flex-column align-items-center justify-content-center p-2">
                            <i class="fas fa-bed text-secondary mb-1"></i>
                            <span class="fw-bold fs-5 lh-1">{{ property.bedrooms }}</span>
                            <small class="text-muted" style="font-size: 0.75rem;">Dorm</small>
                        </div>
                    </div>
                    <div class="col text-center border-end">
                        <div class="d-flex flex-column align-items-center justify-content-center p-2">
                            <i class="fas fa-bath text-secondary mb-1"></i>
                             <div class="lh-1">
                                <span class="fw-bold fs-5">{{ property.bathrooms }}</span>
                                {% if property.half_bathrooms %}<small class="text-muted">.5</small>{% endif %}
                             </div>
                            <small class="text-muted" style="font-size: 0.75rem;">Baños</small>
                        </div>
                    </div>
                    {% if property.built_area %}
                    <div class="col text-center">
                        <div class="d-flex flex-column align-items-center justify-content-center p-2">
                            <i class="fas fa-ruler-combined text-secondary mb-1"></i>
                            <span class="fw-bold fs-5 lh-1">{{ property.built_area|floatformat:0 }}</span>
                            <small class="text-muted" style="font-size: 0.75rem;">{{ property.built_area_unit.symbol }} Const.</small>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col text-center border-end border-top pt-2">
                         <div class="d-flex flex-column align-items-center justify-content-center p-2">
                            <i class="fas fa-car text-secondary mb-1"></i>
                            <span class="fw-bold fs-5 lh-1">{{ property.garage_spaces }}</span>
                            <small class="text-muted" style="font-size: 0.75rem;">Cocheras</small>
                        </div>
                    </div>
                     <div class="col text-center border-end border-top pt-2">
                         <div class="d-flex flex-column align-items-center justify-content-center p-2">
                            <i class="fas fa-building text-secondary mb-1"></i>
                            <span class="fw-bold fs-5 lh-1">{{ property.floors }}</span>
                            <small class="text-muted" style="font-size: 0.75rem;">Pisos</small>
                        </div>
                    </div>
                     <div class="col text-center border-top pt-2">
                         <div class="d-flex flex-column align-items-center justify-content-center p-2">
                            <i class="fas fa-hourglass-half text-secondary mb-1"></i>
                            <span class="fw-bold fs-5 lh-1">{{ property.antiquity_years|default:"-" }}</span>
                            <small class="text-muted" style="font-size: 0.75rem;">Años</small>
                        </div>
                    </div>
                </div>

                <!-- Descripción y Datos Extra -->
                <div class="row g-3">
                    <!-- Descripción -->
                    <div class="col-12">
                        <div class="bg-light p-3 rounded">
                            <h6 class="fw-bold small text-uppercase text-muted mb-2">Descripción</h6>
                            <p class="small mb-0 text-muted" style="white-space: pre-line; text-align: justify;">{{ property.description|truncatechars:400 }}</p>
                            {% if property.description|length > 400 %}
                            <button class="btn btn-link btn-sm p-0 text-decoration-none mt-1" data-bs-toggle="modal" data-bs-target="#descriptionModal">Ver más</button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Detalles Técnicos Compactos -->
                    <div class="col-12">
                         <h6 class="fw-bold small text-uppercase text-muted mb-2 border-bottom pb-1">Detalles Técnicos</h6>
                         <div class="row row-cols-2 g-2 small">
                            <div class="col d-flex justify-content-between">
                                <span class="text-muted">Frente:</span>
                                <span class="fw-semibold">{{ property.front_measure|default:"-" }}m</span>
                            </div>
                             <div class="col d-flex justify-content-between">
                                <span class="text-muted">Fondo:</span>
                                <span class="fw-semibold">{{ property.depth_measure|default:"-" }}m</span>
                            </div>
                             <div class="col d-flex justify-content-between">
                                <span class="text-muted">Zonificación:</span>
                                <span class="fw-semibold">{{ property.zoning|default:"-" }}</span>
                            </div>
                             <div class="col d-flex justify-content-between">
                                <span class="text-muted">Agua/Luz:</span>
                                <span class="fw-semibold">{% if property.water_service %}Sí{% else %}-{% endif %} / {% if property.energy_service %}Sí{% else %}-{% endif %}</span>
                            </div>
                         </div>
                    </div>
                    
                    {% if property.amenities %}
                    <div class="col-12">
                        <h6 class="fw-bold small text-uppercase text-muted mb-1 border-bottom pb-1">Amenidades</h6>
                        <p class="small text-muted mb-0">{{ property.amenities|truncatechars:100 }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Fullscreen para Imágenes -->
<div class="modal fade" id="fullImageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen bg-black">
        <div class="modal-content bg-black h-100">
            <div class="modal-header border-0 bg-black p-2 position-absolute top-0 end-0" style="z-index: 1055;">
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1); opacity: 0.8;"></button>
            </div>
            <div class="modal-body p-0 d-flex align-items-center justify-content-center bg-black position-relative">
                 <img id="fullModalImage" src="" alt="Fullscreen" class="img-fluid" style="max-height: 100vh; max-width: 100vw; object-fit: contain;">
                 <div id="fullImageCaption" class="position-absolute bottom-0 start-0 w-100 text-center p-3 text-white bg-dark bg-opacity-75"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Descripción Completa -->
<div class="modal fade" id="descriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Descripción Completa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="white-space: pre-line;">{{ property.description }}</div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var myCarouselEl = document.getElementById('propertyCarousel');
        if (myCarouselEl) {
            var carousel = bootstrap.Carousel.getOrCreateInstance(myCarouselEl);
            
            myCarouselEl.addEventListener('slide.bs.carousel', function (event) {
                var index = event.to;
                document.querySelectorAll('.thumb-item').forEach(el => {
                    el.classList.remove('border-primary', 'opacity-100');
                    el.style.opacity = '0.6';
                });
                var activeThumb = document.getElementById('thumb-' + index);
                if (activeThumb) {
                    activeThumb.classList.add('border-primary', 'opacity-100');
                    activeThumb.style.opacity = '1';
                    activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });
        }
    });

    function goToSlide(index) {
        var myCarouselEl = document.getElementById('propertyCarousel');
        if (myCarouselEl) {
            var carousel = bootstrap.Carousel.getOrCreateInstance(myCarouselEl);
            carousel.to(index);
        }
    }

    function openFullscreenModal(src, caption) {
        var modalImg = document.getElementById('fullModalImage');
        var modalCaption = document.getElementById('fullImageCaption');
        modalImg.src = src;
        modalCaption.textContent = caption || '';
        modalCaption.style.display = caption ? 'block' : 'none';
        var myModal = new bootstrap.Modal(document.getElementById('fullImageModal'));
        myModal.show();
    }
</script>
{% endblock %}
