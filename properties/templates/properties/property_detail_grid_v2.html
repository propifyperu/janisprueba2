{% extends 'properties/base_dashboard.html' %}
{% load static %}
{% load field_permissions %}

{% block title %}{{ property.title }} - Detalles{% endblock %}

{% block dashboard_content %}
<div class="container-fluid py-2 h-100 d-flex flex-column">
    
    <!-- Header de Acciones -->
    <div class="d-flex justify-content-end mb-2">
        <div class="btn-group btn-group-sm">
            {% if user.is_superuser or property.created_by.id == user.id %}
            <a href="{% url 'properties:edit' property.pk %}" class="btn btn-outline-primary" title="Editar">
                <i class="fas fa-edit me-1"></i>Editar
            </a>
            {% endif %}
            <a href="{% url 'properties:timeline' property.pk %}" class="btn btn-outline-secondary" title="Historial">
                <i class="fas fa-history me-1"></i>Historial
            </a>
            <a href="{% url 'properties:list' %}" class="btn btn-outline-secondary" title="Volver">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <div class="row g-2">
        <!-- COLUMNA IZQUIERDA: Galería y Resumen Clave (Sticky) -->
        <div class="col-lg-3 col-md-4">
            <div class="d-flex flex-column gap-2 h-100">
                
                <div class="bg-white p-2 rounded shadow-sm border">
                    <!-- Título y Precio -->
                    <div class="mb-2 text-center">
                        <h6 class="fw-bold text-dark mb-1 lh-sm text-truncate" title="{{ property.exact_address|default:property.title }}">
                            {{ property.exact_address|default:property.title }}
                        </h6>
                        {% if field_permissions.price.can_view or not field_permissions.price %}
                        <div class="fw-bold text-primary">
                            {{ property.currency.symbol }} {{ property.price|floatformat:0 }}
                        </div>
                        {% endif %}
                        {% if property.codigo_unico_propiedad %}
                        <div class="text-muted d-block" style="font-size: 0.7rem;"><i class="fas fa-hashtag me-1"></i>{{ property.codigo_unico_propiedad }}</div>
                        {% endif %}
                    </div>

                    <!-- Carrusel de Fotos (Galería) -->
                    <div class="position-relative bg-light rounded overflow-hidden mb-2 border mx-auto" style="aspect-ratio: 4/3; max-height: 200px;">
                        {% if property.images.all %}
                            <div id="propertyCarousel" class="carousel slide w-100 h-100" data-bs-ride="false">
                                <div class="carousel-inner w-100 h-100">
                                    {% for image in property.images.all %}
                                    <div class="carousel-item w-100 h-100 {% if forloop.first %}active{% endif %}" onclick="openFullscreenModal('{% if image.image_blob %}{% url 'properties:image_blob' image.id %}{% else %}{{ image.image.url }}{% endif %}', '{{ image.caption|escapejs }}')">
                                        {% if image.image_blob %}
                                            <img src="{% url 'properties:image_blob' image.id %}" class="d-block w-100 h-100" style="object-fit: cover; cursor: zoom-in;" alt="{{ image.caption }}">
                                        {% elif image.image %}
                                            <img src="{{ image.image.url }}" class="d-block w-100 h-100" style="object-fit: cover; cursor: zoom-in;" alt="{{ image.caption }}">
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if property.images.count > 1 %}
                                <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev" style="width: 15%;">
                                    <span class="carousel-control-prev-icon bg-dark bg-opacity-50 rounded-1" style="width: 1.5rem; height: 1.5rem;" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next" style="width: 15%;">
                                    <span class="carousel-control-next-icon bg-dark bg-opacity-50 rounded-1" style="width: 1.5rem; height: 1.5rem;" aria-hidden="true"></span>
                                </button>
                                {% endif %}
                                <div class="position-absolute bottom-0 end-0 m-1 badge bg-dark bg-opacity-75" style="font-size: 0.7rem;">
                                    <i class="fas fa-images me-1"></i>{{ property.images.count }}
                                </div>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center justify-content-center w-100 h-100 text-muted">
                                <i class="fas fa-image fa-2x"></i>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Resumen Rápido -->
                    <div class="row g-1 text-center small text-secondary">
                        <div class="col-4">
                            <div class="p-1 border rounded bg-light" title="Dormitorios">
                                <i class="fas fa-bed mb-1 d-block text-primary" style="font-size: 0.8rem;"></i>
                                <span class="fw-bold text-dark">{{ property.bedrooms }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-1 border rounded bg-light" title="Baños">
                                <i class="fas fa-bath mb-1 d-block text-primary" style="font-size: 0.8rem;"></i>
                                <span class="fw-bold text-dark">{{ property.bathrooms }}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-1 border rounded bg-light" title="Cocheras">
                                <i class="fas fa-car mb-1 d-block text-primary" style="font-size: 0.8rem;"></i>
                                <span class="fw-bold text-dark">{{ property.garage_spaces }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Box Responsable / Contacto -->
                 <div class="card shadow-sm border-0 flex-grow-1">
                    <div class="card-header bg-white border-bottom-0 fw-bold text-uppercase small text-muted py-1 px-2">
                        <i class="fas fa-address-card me-2"></i>Contacto
                    </div>
                    <div class="card-body py-2 px-2 small">
                        <div class="mb-2">
                            <strong class="text-dark d-block" style="font-size: 0.75rem;">Propietario</strong>
                            {% if property.owner %}
                                <span class="text-muted d-block text-truncate">{{ property.owner.first_name }} {{ property.owner.last_name }}</span>
                            {% else %}
                                <span class="text-warning">Sin asignar</span>
                            {% endif %}
                        </div>
                        <div>
                            <strong class="text-dark d-block" style="font-size: 0.75rem;">Responsable</strong>
                            <span class="text-muted d-block text-truncate">{{ property.responsible.get_full_name|default:property.created_by.get_full_name|default:property.created_by.username }}</span>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- COLUMNA CENTRAL: Grid Compacto -->
        <div class="col-lg-9 col-md-8">
            <div class="row g-2">
                
                <!-- 1. INFORMACIÓN BÁSICA -->
                <div class="col-12 col-md-6">
                    <div class="card shadow-sm border h-100">
                        <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                            <i class="fas fa-home me-2"></i>Información Básica
                        </div>
                        <div class="card-body pt-0 px-2 pb-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Tipo</label>
                                    <div class="text-truncate small">{{ property.property_type.name|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Subtipo</label>
                                    <div class="text-truncate small">{{ property.property_subtype.name|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Estado</label>
                                    <span class="badge bg-light text-dark border small py-0">{{ property.status.name|default:"-" }}</span>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Condición</label>
                                    <div class="text-truncate small">{{ property.condition.name|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Forma de Pago</label>
                                    <div class="text-truncate small">{{ property.forma_de_pago.name|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                     <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Mantenimiento</label>
                                     <div class="small">{% if property.has_maintenance %}Sí{% else %}No{% endif %}</div>
                                </div>
                                {% if property.is_project %}
                                <div class="col-12">
                                    <div class="alert alert-info py-1 px-2 small mb-0" style="font-size: 0.75rem;">
                                        <i class="fas fa-building me-1"></i> Proyecto: <strong>{{ property.project_name|default:"-" }}</strong>
                                    </div>
                                </div>
                                {% endif %}
                                {% if property.antiquity_years or property.delivery_date %}
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Antigüedad</label>
                                    <div class="small">{{ property.antiquity_years|default:"-" }} años</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Entrega</label>
                                    <div class="small">{{ property.delivery_date|date:"d/m/Y"|default:"-" }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. NEGOCIACIÓN Y FINANZAS -->
                <div class="col-12 col-md-6">
                    <div class="card shadow-sm border h-100">
                        <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                            <i class="fas fa-handshake me-2"></i>Negociación y Finanzas
                        </div>
                        <div class="card-body pt-0 px-2 pb-2">
                             <div class="row g-2">
                                <div class="col-4">
                                    <div class="p-1 border rounded bg-light bg-opacity-50 text-center">
                                        <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Com. Inicial</label>
                                        <span class="fw-bold text-success small">{{ property.initial_commission_percentage|default:"0" }}%</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-1 border rounded bg-light bg-opacity-50 text-center">
                                        <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Com. Final</label>
                                        <span class="fw-bold text-success small">{{ property.final_commission_percentage|default:"0" }}%</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-1 border rounded bg-light bg-opacity-50 text-center">
                                        <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Cierre</label>
                                        <span class="fw-bold text-dark small" style="font-size: 0.75rem;">{{ property.currency.symbol }} {{ property.final_amount|floatformat:0|default:"0" }}</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                     <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Estado Negociación</label>
                                     <div class="small"><span class="badge bg-warning text-dark py-0">{{ property.negotiation_status.name|default:"-" }}</span></div>
                                </div>
                                <div class="col-6">
                                     <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Tipo de Contrato</label>
                                     <div class="small fw-bold text-truncate">{{ property.contract_type.name|default:"-" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- 3. CARACTERÍSTICAS -->
                 <div class="col-12 col-md-6">
                     <div class="card shadow-sm border h-100">
                         <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                            <i class="fas fa-ruler-combined me-2"></i>Características
                        </div>
                        <div class="card-body pt-0 px-2 pb-2">
                            <div class="row g-2">
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">A. Terreno</label>
                                    <div class="small fw-bold">{{ property.land_area|floatformat:0 }} <span class="text-muted" style="font-size: 0.6rem;">{{ property.land_area_unit.symbol }}</span></div>
                                </div>
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">A. Const.</label>
                                    <div class="small fw-bold">{{ property.built_area|floatformat:0 }} <span class="text-muted" style="font-size: 0.6rem;">{{ property.built_area_unit.symbol }}</span></div>
                                </div>
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Frentera</label>
                                    <div class="small">{{ property.front_measure|default:"-" }}</div>
                                </div>
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold text-truncate" style="font-size: 0.65rem;">Fondo</label>
                                    <div class="small">{{ property.depth_measure|default:"-" }}</div>
                                </div>
                                
                                <div class="col-12 border-top my-1"></div>

                                <div class="col-4">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">½ Baños</label>
                                    <div class="small">{{ property.half_bathrooms }}</div>
                                </div>
                                <div class="col-4">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Pisos</label>
                                    <div class="small">{{ property.floors }}</div>
                                </div>
                                <div class="col-4">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Garaje</label>
                                    <div class="small text-truncate">{{ property.garage_type.name|default:"-" }}</div>
                                </div>

                                {% if property.parking_cost > 0 %}
                                <div class="col-12">
                                    <div class="small text-muted fst-italic" style="font-size: 0.75rem;">Cochera: <strong>{{ property.parking_cost }}</strong> (Incl: {{ property.parking_cost_included|yesno:"Sí,No" }})</div>
                                </div>
                                {% endif %}
                                {% if property.zoning %}
                                <div class="col-12">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Zonificación</label>
                                    <div class="small text-truncate">{{ property.zoning }}</div>
                                </div>
                                {% endif %}
                            </div>
                         </div>
                     </div>
                 </div>

                 <!-- 4. UBICACIÓN -->
                 <div class="col-12 col-md-6">
                     <div class="card shadow-sm border h-100">
                         <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                            <i class="fas fa-map-marker-alt me-2"></i>Ubicación
                        </div>
                        <div class="card-body pt-0 px-2 pb-2">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Dirección Real</label>
                                    <div class="small text-truncate" title="{{ property.real_address }}">{{ property.real_address|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Departamento</label>
                                    <div class="small text-truncate">{{ property.department.name|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Provincia</label>
                                    <div class="small text-truncate">{{ property.province.name|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Distrito</label>
                                    <div class="small text-truncate">{{ property.district.name|default:"-" }}</div>
                                </div>
                                <div class="col-6">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Urbanización</label>
                                    <div class="small text-truncate">{{ property.urbanization.name|default:"-" }}</div>
                                </div>
                                <div class="col-12">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Coordenadas</label>
                                    <div class="small text-monospace bg-light rounded px-1 py-0 text-truncate" style="font-size: 0.7rem;">{{ property.coordinates|default:"-" }}</div>
                                </div>
                                {% if property.google_maps_url %}
                                <div class="col-12 text-end">
                                    <a href="{{ property.google_maps_url }}" target="_blank" class="btn btn-sm btn-link text-success p-0" style="font-size: 0.75rem; text-decoration: none;">
                                        <i class="fas fa-external-link-alt me-1"></i>Google Maps
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                         </div>
                     </div>
                 </div>

                 <!-- 5. SERVICIOS -->
                 <div class="col-12 col-md-6">
                     <div class="card shadow-sm border h-100">
                         <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                            <i class="fas fa-wrench me-2"></i>Servicios
                        </div>
                        <div class="card-body pt-0 px-2 pb-2">
                            <div class="row g-2">
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Agua</label>
                                    <div class="small">{{ property.water_service.name|default:"-" }}</div>
                                </div>
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Luz</label>
                                    <div class="small">{{ property.energy_service.name|default:"-" }}</div>
                                </div>
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Desagüe</label>
                                    <div class="small">{{ property.drainage_service.name|default:"-" }}</div>
                                </div>
                                <div class="col-3 text-center">
                                    <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Gas</label>
                                    <div class="small">{{ property.gas_service.name|default:"-" }}</div>
                                </div>
                            </div>
                         </div>
                     </div>
                 </div>

                 <!-- 6. PUBLICIDAD -->
                 <div class="col-12 col-md-6">
                     <div class="card shadow-sm border h-100">
                         <div class="card-header bg-white fw-bold text-primary border-bottom-0 py-1 px-2 small">
                            <i class="fas fa-bullhorn me-2"></i>Publicidad
                        </div>
                        <div class="card-body pt-0 px-2 pb-2">
                            <div class="mb-1">
                                <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Título</label>
                                <div class="small fw-bold text-truncate">{{ property.title }}</div>
                            </div>
                            <div>
                                <label class="d-block text-muted fw-bold" style="font-size: 0.7rem;">Descripción</label>
                                <div class="small text-secondary text-truncate" style="max-height: 60px; overflow: hidden;" title="{{ property.description }}">
                                    {{ property.description|default:"Sin descripción" }}
                                </div>
                            </div>
                         </div>
                     </div>
                 </div>

            </div>
        </div>
    </div>
</div>

<!-- Modal Fullscreen -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true" style="z-index: 10000;">
    <div class="modal-dialog modal-fullscreen bg-black">
        <div class="modal-content bg-black">
            <div class="modal-header border-0 bg-black text-white p-2">
                <h5 class="modal-title fs-6" id="modalImageCaption"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex align-items-center justify-content-center bg-black position-relative">
                <img src="" id="modalImage" class="img-fluid" style="max-height: 90vh; max-width: 100vw; object-fit: contain;">
                <button class="btn btn-dark position-absolute top-50 start-0 translate-middle-y ms-3 rounded-circle bg-opacity-50 border-0" onclick="prevModalImage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-3 rounded-circle bg-opacity-50 border-0" onclick="nextModalImage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const imagesList = [
        {% for image in property.images.all %}
        {
            src: "{% if image.image_blob %}{% url 'properties:image_blob' image.id %}{% else %}{{ image.image.url }}{% endif %}",
            caption: "{{ image.caption|escapejs }}"
        },
        {% endfor %}
    ];
    let currentImageIndex = 0;
    const modalInstance = new bootstrap.Modal(document.getElementById('imageModal'));

    function openFullscreenModal(src, caption) {
        currentImageIndex = imagesList.findIndex(img => img.src === src);
        updateModalContent();
        modalInstance.show();
    }

    function updateModalContent() {
        if(currentImageIndex < 0) return;
        const img = imagesList[currentImageIndex];
        document.getElementById('modalImage').src = img.src;
        document.getElementById('modalImageCaption').textContent = img.caption || 'Imagen ' + (currentImageIndex + 1);
    }

    function nextModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex + 1) % imagesList.length;
        updateModalContent();
    }

    function prevModalImage() {
        if (imagesList.length === 0) return;
        currentImageIndex = (currentImageIndex - 1 + imagesList.length) % imagesList.length;
        updateModalContent();
    }

    document.addEventListener('keydown', function(event) {
        if (!document.getElementById('imageModal').classList.contains('show')) return;
        if (event.key === 'ArrowLeft') prevModalImage();
        if (event.key === 'ArrowRight') nextModalImage();
    });
</script>
{% endblock %}
