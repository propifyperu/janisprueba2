{% extends 'properties/base_dashboard.html' %}
{% block title %}Bandeja de entrada{% endblock %}
{% block dashboard_content %}
<div id="inbox-full-bleed" class="container-fluid my-2">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Bandeja de entrada</h3>
    <div>
      <a class="btn btn-outline-secondary me-2" href="{% url 'chat:sent' %}">Enviados</a>
      <a class="btn btn-primary" href="{% url 'chat:compose' %}">Redactar</a>
    </div>
  </div>
    <div class="row g-0">
      <div class="col-md-3 px-0">
        <div class="list-group" style="max-height:600px; overflow:auto; border-right:1px solid #e9ecef;">
          {% for item in threads %}
            <a href="?selected={{ item.thread.pk }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center inbox-item" title="{{ item.thread.title|default:'Sin asunto' }} - {{ item.last.sender_name }}: {{ item.last.body|truncatechars:120 }}">
              <div class="inbox-item-left">
                <div class="inbox-subject">{{ item.thread.title|default:'Sin asunto' }}</div>
                <div class="inbox-snippet small text-muted">{{ item.last.sender_name }} · {{ item.last.body|truncatechars:60 }}</div>
              </div>
              <div class="inbox-date small text-muted">{{ item.thread.updated_at|date:'d/m/Y' }}</div>
            </a>
          {% empty %}
            <div class="alert alert-light">No hay mensajes en la bandeja de entrada.</div>
          {% endfor %}
        </div>
      </div>

      <div class="col-md-9">
        {% if selected_thread %}
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="small text-muted">Para:</div>
                  <div class="fw-bold mb-2">{% for u in selected_thread.participants.all %}{{ u.get_full_name|default:u.username }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                  <div class="small text-muted">Asunto: <strong>{{ selected_thread.title|default:'Sin asunto' }}</strong></div>
                  <div class="small text-muted">Fecha: {{ selected_thread.updated_at }}</div>
                </div>
                <div>
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'chat:conversation_detail' selected_thread.pk %}">Ver hilo</a>
                  <button class="btn btn-sm btn-primary" id="replyTopBtn">Responder</button>
                </div>
              </div>

                      <hr />
                      <script>
                        // marcar visualmente el item seleccionado en la lista izquierda
                        (function(){
                          const params = new URLSearchParams(window.location.search);
                          const sel = params.get('selected');
                          if(sel){
                            const el = document.querySelector('.inbox-item[href="?selected='+sel+'"]');
                            if(el) el.classList.add('selected');
                          }
                          document.querySelectorAll('.inbox-item').forEach(a=>{
                            a.addEventListener('click', function(){
                              document.querySelectorAll('.inbox-item.selected').forEach(x=>x.classList.remove('selected'));
                              this.classList.add('selected');
                            });
                          });
                        })();
                      </script>
              <div>
                {% for m in messages %}
                  <div class="message-row mb-3">
                    <div class="small text-muted">De: {{ m.sender_name }} · {{ m.created_at }}</div>
                    <div class="mt-1">{{ m.body|linebreaksbr }}</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% else %}
          <div class="alert alert-light">Seleccione un hilo a la izquierda para ver su detalle.</div>
        {% endif %}
      </div>
    </div>

    <style>
      /* mover el contenedor ligeramente a la izquierda para anular el padding del main-content-inner */
      #inbox-full-bleed { margin-left: -2rem; width: calc(100% + 2rem); padding-left: 0; }
      /* lista muy delgada a la izquierda, empieza al borde del sidebar principal */
      .inbox-item { padding-top:0; padding-bottom:0; height:20px; min-height:20px; display:flex; align-items:center; }
      .inbox-item .inbox-subject { font-size:0.82rem; line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; }
      .inbox-item .inbox-snippet { display:none; }
      .inbox-item .inbox-date { font-size:0.72rem; }
      .message-row { border-bottom:1px solid #f0f0f0; padding-bottom:10px; }
      #replyTopBtn { height:28px; padding:2px 8px; }
      /* detalle: fondo verde suave, más oscuro que el fondo claro pero más claro que la barra lateral */
      .detail-card { background: rgba(4,125,125,0.06); border: 1px solid rgba(4,125,125,0.08); }
      /* footer: empujar al fondo garantizando altura mínima del main */
      main { min-height: calc(100vh - 120px); }
      /* item seleccionado en lista izquierda */
      .inbox-item.selected { background: rgba(4,125,125,0.12) !important; color: #043737; }
      /* asegurar que la columna izquierda no añade padding extra */
      .col-md-3.px-0 { padding-left:0 !important; padding-right:0 !important; }
      @media (max-width:767px){ .inbox-item .inbox-subject { max-width:120px; } }
    </style>
</div>
{% endblock %}
