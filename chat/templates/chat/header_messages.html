{% load static %}
<style>
  /* Asegurar que el dropdown de mensajes se muestre por encima de la línea/divisor del header */
  .dropdown-menu.messages-dropdown {
    z-index: 3001 !important;
  }
  /* Ajuste adicional por si Bootstrap aplica otro selector */
  .dropdown-menu.show {
    z-index: 3001 !important;
  }
</style>
<div class="dropdown">
  <button class="btn btn-transparent dropdown-toggle p-0" type="button" id="messagesDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="display:inline-flex; width:36px; height:36px; align-items:center; justify-content:center; border-radius:8px; background:transparent; border:1px solid rgba(0,0,0,0.08); color:#6c757d;">
    <i class="far fa-envelope"></i>
    <span id="messagesBadge" class="badge bg-danger" style="position:absolute; transform:translate(12px,-10px); display:none;">0</span>
  </button>
  <ul class="dropdown-menu dropdown-menu-end p-2 messages-dropdown" aria-labelledby="messagesDropdown" style="width:360px;">
    <li class="dropdown-header d-flex justify-content-between align-items-center">
      <div>
        <strong>Mensajes</strong>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'chat:inbox' %}" class="btn btn-sm btn-outline-secondary">Bandeja</a>
        <a href="{% url 'chat:sent' %}" class="btn btn-sm btn-outline-secondary">Enviados</a>
        <a href="{% url 'chat:compose' %}" class="btn btn-sm btn-outline-primary">Redactar</a>
      </div>
    </li>
    <li><div id="messagesPreview" style="max-height:300px; overflow:auto;"></div></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item text-center" href="{% url 'chat:conversation_list' %}">Ver todos los mensajes</a></li>
  </ul>
</div>

<script>
async function refreshMessagesBadge() {
  try {
    const res = await fetch('{% url "chat:unread_count" %}');
    if (!res.ok) return;
    const data = await res.json();
    const badge = document.getElementById('messagesBadge');
    const preview = document.getElementById('messagesPreview');
    if (data.count && data.count > 0) {
      badge.style.display = 'inline-block';
      badge.textContent = data.count;
    } else {
      badge.style.display = 'none';
    }
    // render previews
    preview.innerHTML = '';
    data.preview.forEach(function(p){
      const el = document.createElement('div');
      el.className = 'mb-2';
      el.innerHTML = `<a href="/chat/c/${p.conversation_id}/" data-conv="${p.conversation_id}" class="d-flex gap-2 align-items-start text-decoration-none text-dark preview-link">
          <div style="width:42px; height:42px; background:#f1f1f1; border-radius:6px; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user"></i></div>
          <div style="flex:1;">
            <div class="small text-muted">${p.sender} · <small>${new Date(p.created_at).toLocaleString()}</small></div>
            <div class="fw-semibold">${p.title}</div>
            <div class="small text-truncate text-muted">${p.snippet}</div>
          </div>
        </a>`;
      preview.appendChild(el);
    });
    // attach click handlers to preview links to mark as read before navigating
    preview.querySelectorAll('.preview-link').forEach(function(a){
      a.addEventListener('click', async function(e){
        e.preventDefault();
        const conv = this.dataset.conv;
        try{
          await fetch('{% url "chat:mark_read" %}', {method:'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'}, body: new URLSearchParams({'conversation': conv})});
        }catch(err){console.error(err)}
        // refresh badge after marking
        await refreshMessagesBadge();
        // proceed to conversation
        window.location.href = this.href;
      });
    });
  } catch(e) {
    console.error(e);
  }
}

// Poll every 60s
setInterval(refreshMessagesBadge, 60000);
// refresh on load
refreshMessagesBadge();
</script>
